@page "/"
@using Microsoft.AspNetCore.Components.Web
@namespace SchedulerMVP.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SchedulerMVP</title>
    <base href="~/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/login.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,300..700,0..1,-50..200" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(SchedulerMVP.Components.App)" render-mode="Server" />

    

    <script src="js/dragdrop.js"></script>
    <script src="js/blazor-connection.js"></script>
    <script>
        // CRITICAL: Configure Blazor before loading the script
        window.Blazor = {
            start: function(options) {
                console.log('[Blazor] Blazor.start() called with options:', options);
                // Force SignalR to use correct path
                if (options && !options.configureSignalR) {
                    options.configureSignalR = function(builder) {
                        console.log('[Blazor SignalR] Configuring SignalR connection...');
                        // Ensure we're using the correct base path
                        builder.withUrl('/_blazor', {
                            skipNegotiation: false,
                            // Prioritize Long Polling - WebSocket has issues on Fly.io proxy
                            transport: Microsoft.AspNetCore.Http.Connections.HttpTransportType.LongPolling | Microsoft.AspNetCore.Http.Connections.HttpTransportType.WebSockets
                        });
                        console.log('[Blazor SignalR] SignalR configured');
                    };
                }
                // Call the real start function
                if (window._blazorStart) {
                    return window._blazorStart(options);
                }
            }
        };
    </script>
    <script src="_framework/blazor.server.js"></script>
    <script>
        // Capture the real Blazor.start before our override
        window.addEventListener('DOMContentLoaded', function() {
            console.log('[Blazor] DOMContentLoaded - checking for real Blazor.start...');
            if (window.Blazor && window.Blazor.start && !window._blazorStart) {
                window._blazorStart = window.Blazor.start;
            }
        });
        
        // Ensure Blazor is loaded before initializing connection monitoring
        window.addEventListener('load', function() {
            console.log('[Blazor] Window loaded, checking Blazor...');
            
            // Wait for Blazor to be available
            const checkBlazor = setInterval(function() {
                if (window.Blazor && window.Blazor.start) {
                    clearInterval(checkBlazor);
                    console.log('[Blazor] Blazor framework detected');
                    
                    // Log when Blazor actually tries to connect
                    if (window.Blazor._internal) {
                        console.log('[Blazor] Internal Blazor object found');
                    }
                    
                    // Monitor for connection issues
                    const originalStart = window.Blazor.start;
                    window.Blazor.start = function(options) {
                        console.log('[Blazor] Blazor.start() intercepted - starting connection...');
                        console.log('[Blazor] Options:', options);
                        
                        // Ensure SignalR is configured
                        if (!options) options = {};
                        if (!options.configureSignalR) {
                            options.configureSignalR = function(builder) {
                                console.log('[Blazor SignalR] Configuring SignalR with builder:', builder);
                                try {
                                    builder.withUrl('/_blazor');
                                    console.log('[Blazor SignalR] SignalR URL set to /_blazor');
                                } catch (e) {
                                    console.error('[Blazor SignalR] Error configuring SignalR:', e);
                                }
                            };
                        }
                        
                        const result = originalStart.apply(this, [options]);
                        
                        // Log connection status
                        setTimeout(function() {
                            console.log('[Blazor] Blazor Server start completed');
                            if (window.blazorConnection) {
                                window.blazorConnection.connectionState = 'Connected';
                            }
                        }, 1000);
                        
                        return result;
                    };
                }
            }, 100);
            
            // Timeout after 5 seconds
            setTimeout(function() {
                if (!window.Blazor) {
                    clearInterval(checkBlazor);
                    console.error('[Blazor] ERROR: Blazor not loaded after 5 seconds!');
                    if (window.blazorConnection) {
                        window.blazorConnection.showConnectionError('Blazor kunde inte laddas. Kontrollera konsolen f√∂r detaljer.');
                    }
                }
            }, 5000);
            
        });
    </script>
</body>
</html>

