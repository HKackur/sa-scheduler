@page "/"
@using Microsoft.AspNetCore.Components.Web
@namespace SchedulerMVP.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SchedulerMVP</title>
    <base href="~/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/login.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,300..700,0..1,-50..200" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(SchedulerMVP.Components.App)" render-mode="Server" />

    

    <script src="js/dragdrop.js"></script>
    <script src="js/blazor-connection.js"></script>
    <script>
        // CRITICAL: Configure Blazor before loading the script
        window.Blazor = {
            start: function(options) {
                console.log('[Blazor] Blazor.start() called with options:', options);
                // Force SignalR to use correct path
                if (options && !options.configureSignalR) {
                    options.configureSignalR = function(builder) {
                        console.log('[Blazor SignalR] Configuring SignalR connection...');
                        // Ensure we're using the correct base path
                        builder.withUrl('/_blazor', {
                            skipNegotiation: false,
                            transport: Microsoft.AspNetCore.Http.Connections.HttpTransportType.WebSockets | Microsoft.AspNetCore.Http.Connections.HttpTransportType.LongPolling
                        });
                        console.log('[Blazor SignalR] SignalR configured');
                    };
                }
                // Call the real start function
                if (window._blazorStart) {
                    return window._blazorStart(options);
                }
            }
        };
    </script>
    <script src="_framework/blazor.server.js"></script>
    <script>
        // Capture the real Blazor.start before our override
        window.addEventListener('DOMContentLoaded', function() {
            console.log('[Blazor] DOMContentLoaded - checking for real Blazor.start...');
            if (window.Blazor && window.Blazor.start && !window._blazorStart) {
                window._blazorStart = window.Blazor.start;
            }
        });
        
        // Ensure Blazor is loaded before initializing connection monitoring
        window.addEventListener('load', function() {
            console.log('[Blazor] Window loaded, checking Blazor...');
            
            // Wait for Blazor to be available
            const checkBlazor = setInterval(function() {
                if (window.Blazor && window.Blazor.start) {
                    clearInterval(checkBlazor);
                    console.log('[Blazor] Blazor framework detected');
                    
                    // Log when Blazor actually tries to connect
                    if (window.Blazor._internal) {
                        console.log('[Blazor] Internal Blazor object found');
                    }
                    
                    // Monitor for connection issues
                    const originalStart = window.Blazor.start;
                    window.Blazor.start = function(options) {
                        console.log('[Blazor] Blazor.start() intercepted - starting connection...');
                        console.log('[Blazor] Options:', options);
                        
                        // Ensure SignalR is configured
                        if (!options) options = {};
                        if (!options.configureSignalR) {
                            options.configureSignalR = function(builder) {
                                console.log('[Blazor SignalR] Configuring SignalR with builder:', builder);
                                try {
                                    builder.withUrl('/_blazor');
                                    console.log('[Blazor SignalR] SignalR URL set to /_blazor');
                                } catch (e) {
                                    console.error('[Blazor SignalR] Error configuring SignalR:', e);
                                }
                            };
                        }
                        
                        const result = originalStart.apply(this, [options]);
                        
                        // Log connection status
                        setTimeout(function() {
                            console.log('[Blazor] Blazor Server start completed');
                            if (window.blazorConnection) {
                                window.blazorConnection.connectionState = 'Connected';
                            }
                        }, 1000);
                        
                        return result;
                    };
                }
            }, 100);
            
            // Timeout after 5 seconds
            setTimeout(function() {
                if (!window.Blazor) {
                    clearInterval(checkBlazor);
                    console.error('[Blazor] ERROR: Blazor not loaded after 5 seconds!');
                    if (window.blazorConnection) {
                        window.blazorConnection.showConnectionError('Blazor kunde inte laddas. Kontrollera konsolen för detaljer.');
                    }
                }
            }, 5000);
            
            // Attach direct JavaScript click handler to test button as fallback
            // Also create modal in JavaScript if Blazor hasn't created it
            setTimeout(function() {
                const testBtn = document.getElementById('test-button-debug');
                if (testBtn) {
                    console.log('[DEBUG] Test button found in DOM, attaching JavaScript handler');
                    
                    // Create modal elements if they don't exist (Blazor may not have rendered them)
                    let modal = document.getElementById('test-modal');
                    let overlay = document.getElementById('test-modal-overlay');
                    
                    if (!modal || !overlay) {
                        console.log('[DEBUG] Modal elements not found, creating them via JavaScript');
                        // Create overlay
                        overlay = document.createElement('div');
                        overlay.id = 'test-modal-overlay';
                        overlay.className = 'test-modal-overlay';
                        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9998; display: none;';
                        
                        // Create modal
                        modal = document.createElement('div');
                        modal.id = 'test-modal';
                        modal.className = 'test-modal';
                        modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 24px; z-index: 9999; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); min-width: 300px; display: none;';
                        
                        modal.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center;"><h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600;">Yes...det funkar</h3><button id="test-modal-close-btn" style="padding: 8px 16px; background: #1761A5; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Stäng</button></div>';
                        
                        document.body.appendChild(overlay);
                        document.body.appendChild(modal);
                        console.log('[DEBUG] Modal elements created via JavaScript');
                    }
                    
                    testBtn.addEventListener('click', function(e) {
                        console.log('[DEBUG] Test button clicked - JavaScript event handler fired!');
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Show modal directly via JavaScript
                        modal = document.getElementById('test-modal');
                        overlay = document.getElementById('test-modal-overlay');
                        
                        if (modal && overlay) {
                            modal.style.display = 'block';
                            overlay.style.display = 'block';
                            console.log('[DEBUG] Modal shown via JavaScript');
                            
                            // Attach close handler
                            const closeBtn = document.getElementById('test-modal-close-btn') || modal.querySelector('button');
                            const closeHandler = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                modal.style.display = 'none';
                                overlay.style.display = 'none';
                                console.log('[DEBUG] Modal closed via JavaScript');
                            };
                            
                            overlay.onclick = closeHandler;
                            if (closeBtn) {
                                closeBtn.onclick = closeHandler;
                            }
                        } else {
                            alert('TEST BUTTON CLICKED - Modal elements still not found after creation attempt.');
                        }
                        return false;
                    });
                } else {
                    console.error('[DEBUG] Test button NOT found in DOM after 2 seconds');
                }
            }, 2000);
        });
    </script>
</body>
</html>

