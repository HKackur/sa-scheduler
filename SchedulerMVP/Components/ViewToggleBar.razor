@using SchedulerMVP.Services
@using SchedulerMVP.Data.Entities
@using Microsoft.EntityFrameworkCore
@inject UIState UI
@inject IJSRuntime JS
@inject IScheduleTemplateService TemplateService
@inject ICalendarBookingService CalendarBookingService
@inject IDbContextFactory<SchedulerMVP.Data.AppDbContext> DbFactory
@inject IPlaceService PlaceService
@inject UserContextService UserContext
@implements IDisposable

<div class="view-type-bar-container">
    <div class="view-actions-left">
        @if (UI.IsCalendarViewMode)
        {
            <div class="nav-group">
                <button class="btn btn-today" @onclick="GoToToday">Idag</button>
                <button class="btn btn-nav" @onclick="@(UI.IsDayView ? NavigateToPreviousDay : NavigateToPreviousWeek)">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <button class="btn btn-nav" @onclick="@(UI.IsDayView ? NavigateToNextDay : NavigateToNextWeek)">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
                <div class="nav-text">@(UI.IsDayView ? GetFormattedDayText() : $"Vecka {GetWeekNumber()}")</div>
            </div>
        }
        
        <div class="toggle-group">
        <button class="view-btn @(!UI.IsWeekListView && !UI.IsDayView && !UI.IsResourceView ? "active" : "")" 
                @onclick="() => ToggleView(false, false, false)" title="Veckovy">
            <span class="material-symbols-outlined">calendar_view_week</span>
            <span class="btn-label">Vecka</span>
        </button>
        <button class="view-btn @(!UI.IsWeekListView && UI.IsDayView && !UI.IsResourceView ? "active" : "")" 
                @onclick="() => ToggleView(false, true, false)" title="Dagsvy">
            <span class="material-symbols-outlined">calendar_view_day</span>
            <span class="btn-label">Dag</span>
        </button>
        @if (!UI.IsCalendarViewMode)
        {
            <button class="view-btn @(UI.IsWeekListView ? "active" : "")" 
                    @onclick="() => ToggleView(true, false, false)" title="Listvy">
                <span class="material-symbols-outlined">view_list</span>
                <span class="btn-label">Lista</span>
            </button>
            <button class="view-btn @(UI.IsResourceView ? "active" : "")" 
                    @onclick="() => ToggleView(false, false, true)" title="Resursvy">
                <span class="material-symbols-outlined">view_timeline</span>
                <span class="btn-label">Resurs</span>
            </button>
        }
        </div>
    </div>

    @* Centered navigation for Veckoschema day view *@
    @if (!UI.IsCalendarViewMode && UI.IsDayView)
    {
        <div class="view-nav-center">
            <div class="nav-group">
                <button class="btn btn-nav" @onclick="NavigateToPreviousDayWeekSchedule"><span class="material-symbols-outlined">chevron_left</span></button>
                <button class="btn btn-nav" @onclick="NavigateToNextDayWeekSchedule"><span class="material-symbols-outlined">chevron_right</span></button>
            </div>
        </div>
    }

    <div class="view-actions-right">
        @if (!UI.IsCalendarViewMode)
        {
            @* Print/Export action buttons - only in list view, placed before place filter *@
            @if (UI.IsWeekListView)
            {
                <button class="btn-nav" @onclick="PrintListView" title="Skriv ut">
                    <span class="material-symbols-outlined">print</span>
                </button>
                <button class="btn-nav" @onclick="ExportToPDF" title="Spara som PDF">
                    <span class="material-symbols-outlined">picture_as_pdf</span>
                </button>
            }
            
            @* Place/Area filter dropdown for List view *@
            @if (UI.IsWeekListView)
            {
                <div class="list-filter-dropdown-container" style="position: relative;">
                    <button class="tb-select list-filter-trigger" @onclick="ToggleListFilterDropdown" @onclick:stopPropagation="true">
                        @GetListFilterDisplayText()
                    </button>
                    @if (listFilterDropdownOpen)
                    {
                        <div class="menu-overlay" @onclick="CloseListFilterDropdown"></div>
                        <div class="list-filter-dropdown-menu" @onclick:stopPropagation="true">
                            <div class="list-filter-option @(GetListFilterValue() == "" ? "selected" : "")" @onclick="() => SelectListFilter(null, null)">
                                Alla platser
                            </div>
                            @foreach (var place in places)
                            {
                                <div class="list-filter-place-header" @onclick="() => SelectListFilter(place.Id, null)">
                                    @place.Name
                                </div>
                                @if (areasByPlace.ContainsKey(place.Id))
                                {
                                    var placeAreas = areasByPlace[place.Id];
                                    var areaTree = BuildAreaTree(placeAreas);
                                    @foreach (var rootArea in areaTree)
                                    {
                                        @RenderAreaTreeNode(rootArea, place.Id, 24)
                                    }
                                }
                            }
                        </div>
                    }
                </div>
            }
            
            <select class="tb-select" @onchange="OnTemplateChanged">
                @foreach (var t in templates)
                {
                    <option value="@t.Id" selected="@(UI.SelectedTemplateId == t.Id)">@t.Name</option>
                }
            </select>
        }

        <div class="more-group">
            <div style="position: relative;">
                @if (UI.IsCalendarViewMode)
                {
                    <button class="btn-nav btn-nav-with-text" @onclick="ToggleMoreMenu" title="Fler alternativ" aria-label="Fler alternativ">
                        Fler alternativ <span class="material-symbols-outlined">more_vert</span>
                    </button>
                }
                else
                {
                    <button class="btn-nav" @onclick="ToggleMoreMenu" title="Fler alternativ" aria-label="Fler alternativ">
                        <span class="material-symbols-outlined">more_vert</span>
                    </button>
                }
                @if (moreMenuOpen)
                {
                    <div class="menu-overlay" @onclick="CloseMoreMenu"></div>
                    <div class="tb-menu">
                        @if (UI.IsCalendarViewMode)
                        {
                            <button class="tb-item" @onclick="OpenCopyTemplateModal">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">calendar_add_on</span>
                                <span>Lägg till från mall</span>
                            </button>
                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                            <button class="tb-item" @onclick="OpenClearWeekConfirm">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">delete_outline</span>
                                <span>Rensa vecka</span>
                            </button>
                            <button class="tb-item" @onclick="CopyWeekToClipboard">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">content_copy</span>
                                <span>Kopiera vecka</span>
                            </button>
                            <button class="tb-item" @onclick="PasteWeekFromClipboard" disabled="@(!CanPasteWeek())">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">content_paste</span>
                                <span>Klistra in vecka</span>
                            </button>
                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                            <button class="tb-item" @onclick="OpenPublishModal">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">publish</span>
                                <span>Publicera</span>
                            </button>
                        }
                        else
                        {
                            <button class="tb-item" @onclick="OpenEdit">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">edit</span>
                                <span>Hantera mallen</span>
                            </button>
                            <button class="tb-item" @onclick="OpenCreate">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">add</span>
                                <span>Ny tom mall</span>
                            </button>
                            <button class="tb-item" @onclick="OpenCopy">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">content_copy</span>
                                <span>Duplicera mallen</span>
                            </button>
                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                            <button class="tb-item" @onclick="OpenShareModal">
                                <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 8px; color: #6b7280;">link</span>
                                <span>Dela veckoschema</span>
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<ScheduleTemplateEditModal IsOpen="@editOpen" OnClose="CloseEdit" OnSaved="AfterTemplateSaved" />
<ScheduleTemplateCreateModal IsOpen="@createOpen" OnClose="CloseCreate" OnCreated="AfterTemplateSaved" />
<ScheduleTemplateCopyModal IsOpen="@copyOpen" OnClose="CloseCopy" OnCopied="AfterTemplateSaved" />
<PublishToSportAdminModal IsOpen="@publishModalOpen" OnClose="ClosePublishModal" />
<ShareScheduleModal IsOpen="@shareModalOpen" ScheduleTemplateId="@UI.SelectedTemplateId" OnClose="CloseShareModal" />

@if (clearWeekConfirmOpen)
{
    <div class="modal-container" @onclick="CloseClearWeekConfirm">
        <div class="bm-modal" @onclick:stopPropagation="true">
            <div class="bm-header">
                <h2 class="bm-title">Rensa vecka</h2>
            </div>
            <div class="bm-modal-content">
                <p style="margin:0; color:#64748b; line-height:1.5;">@clearWeekConfirmText</p>
            </div>
            <div class="bm-actions">
                <button class="btn-outline" @onclick="CloseClearWeekConfirm">Avbryt</button>
                <button class="btn-danger" @onclick="ConfirmClearWeek">Rensa</button>
            </div>
        </div>
    </div>
    <style>
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px 28px 0 28px;border:1px solid #e6e7ea;border-radius:12px;width:480px;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
        .bm-title{font-size:18px;font-weight:700;color:#0f1720;margin:0}
        .bm-body{margin-bottom:16px}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px;position:sticky;bottom:0;background:#fff;border-top:1px solid #e6e7ea;padding-top:12px;padding-bottom:28px;z-index:10}
        .btn-outline{padding:8px 16px;border:1px solid #e5e7eb;background:#fff;color:#64748b;border-radius:6px;cursor:pointer;font-weight:500;font-size:14px}
        .btn-outline:hover{background:#f9fafb}
        .btn-danger{padding:8px 16px;border:none;background:#dc2626;color:#fff;border-radius:6px;cursor:pointer;font-weight:500;font-size:14px}
        .btn-danger:hover{background:#b91c1c}
    </style>
}

<style>
    .view-type-bar-container {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 12px 16px !important;
        margin-top: 16px !important;
        margin-bottom: 8px !important;
        background: #f8fafc !important; /* Light blue-gray background */
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        width: 100% !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
    }
    
    .view-actions-left {
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
    }

    .view-nav-center {
        position: absolute !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        display: flex !important;
        align-items: center !important;
    }

    .toggle-group {
        display: flex !important;
        background: #f1f5f9 !important;
        border-radius: 8px !important;
        padding: 2px !important;
        gap: 2px !important;
    }

    .view-actions-right {
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
    }
    
    .view-btn {
        border: none !important;
        background: transparent !important;
        padding: 6px 16px !important;
        border-radius: 6px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        color: #64748b !important;
        cursor: pointer !important;
        height: 32px !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }
    
    .view-btn.active {
        background: #fff !important;
        color: #0f172a !important;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
    }
    
    .btn-label { font-size: 13px !important; }
    .view-btn .material-symbols-outlined { font-size: 20px !important; }

    .nav-group { display: flex; align-items: center; gap: 4px; }
    .nav-text { font-weight: 500; margin: 0 8px; font-size: 14px; white-space: nowrap; }
    .btn { height: 34px; padding: 0 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; }
    .btn-today { }
    .tb-select { height: 34px; padding: 0 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 13px; min-width: 180px; color: #333 !important; }
    .btn-nav {
        display: inline-flex;
        padding: 8px;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 6px;
        background: #eeeeee;
        color: #000;
        cursor: pointer;
        transition: all 0.2s;
        width: 34px;
        height: 34px;
        box-sizing: border-box;
    }
    .btn-nav:hover { background: #e4e4e4; }
    .btn-nav:focus { outline: none; background: #eeeeee; border: 1px solid #cfcfcf; }
    .btn-nav .material-symbols-outlined { font-size: 18px; }
    .btn-nav-with-text {
        width: auto;
        padding: 0 16px;
        gap: 8px;
        font-size: 13px;
    }
    .btn-nav-with-text .material-symbols-outlined { font-size: 18px; }
    .tb-menu { position: absolute; top: 40px; right: 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 8px; min-width: 200px; z-index: 1000; }
    .tb-item { display: flex; align-items: center; width: 100%; padding: 8px 12px; border-radius: 6px; border: none; background: transparent; font-size: 13px; cursor: pointer; text-align: left; }
    .tb-item:hover { background: #f1f5f9; }
    .menu-overlay { position: fixed; inset: 0; z-index: 999; }
    
    /* List filter dropdown styles */
    .list-filter-dropdown-container { position: relative; }
    .list-filter-trigger { 
        height: 34px; 
        padding: 0 12px; 
        border-radius: 6px; 
        border: 1px solid #e2e8f0; 
        font-size: 13px; 
        min-width: 180px; 
        color: #333 !important; 
        background: #fff;
        cursor: pointer;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .list-filter-trigger::after {
        content: '▼';
        font-size: 10px;
        margin-left: 8px;
        opacity: 0.6;
    }
    .list-filter-dropdown-menu {
        position: absolute;
        top: 40px;
        left: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        padding: 8px;
        min-width: 250px;
        max-width: 350px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
    }
    .list-filter-option, .list-filter-place-header, .list-filter-area-option {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        text-align: left;
        color: #374151;
    }
    .list-filter-option:hover, .list-filter-place-header:hover, .list-filter-area-option:hover {
        background: #f1f5f9;
    }
    .list-filter-option.selected, .list-filter-area-option.selected {
        background: #eef2ff;
        color: #1e40af;
        font-weight: 500;
    }
    .list-filter-place-header {
        font-weight: 600;
        color: #1f2937;
        margin-top: 4px;
    }
    .list-filter-area-option {
        color: #6b7280;
        font-size: 12px;
    }
</style>

@code {
    private List<ScheduleTemplate> templates = new();
    private bool moreMenuOpen, publishModalOpen, editOpen, createOpen, copyOpen, shareModalOpen;
    private List<Place> places = new();
    private Dictionary<Guid, List<Area>> areasByPlace = new();
    private bool listFilterDropdownOpen = false;
    private bool clearWeekConfirmOpen = false;
    private string clearWeekConfirmText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        UI.OnChanged += HandleUIStateChanged;
        await ReloadTemplatesForPlace();
        await LoadPlacesAndAreasAsync();
    }

    private void HandleUIStateChanged()
    {
        InvokeAsync(async () => {
            await ReloadTemplatesForPlace();
            // Reload places/areas when switching to list view
            if (UI.IsWeekListView && places.Count == 0)
            {
                await LoadPlacesAndAreasAsync();
            }
            StateHasChanged();
        });
    }
    
    private async Task LoadPlacesAndAreasAsync()
    {
        try
        {
            places = await PlaceService.GetPlacesAsync();
            areasByPlace = new Dictionary<Guid, List<Area>>();
            
            foreach (var place in places)
            {
                var areas = await PlaceService.GetAreasForPlaceAsync(place.Id);
                areasByPlace[place.Id] = areas.OrderBy(a => a.Path).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ViewToggleBar] Error loading places/areas: {ex.Message}");
        }
    }
    
    private string GetListFilterValue()
    {
        if (UI.SelectedListFilterAreaId.HasValue)
        {
            return $"area:{UI.SelectedListFilterAreaId.Value}";
        }
        else if (UI.SelectedListFilterPlaceId.HasValue)
        {
            return $"place:{UI.SelectedListFilterPlaceId.Value}";
        }
        return "";
    }
    
    private string GetListFilterDisplayText()
    {
        if (UI.SelectedListFilterAreaId.HasValue && areasByPlace.Values.SelectMany(a => a).FirstOrDefault(a => a.Id == UI.SelectedListFilterAreaId.Value) is Area area)
        {
            var place = places.FirstOrDefault(p => areasByPlace.ContainsKey(p.Id) && areasByPlace[p.Id].Any(a => a.Id == area.Id));
            return place != null ? $"{place.Name} > {area.Name}" : area.Name;
        }
        else if (UI.SelectedListFilterPlaceId.HasValue)
        {
            var place = places.FirstOrDefault(p => p.Id == UI.SelectedListFilterPlaceId.Value);
            return place?.Name ?? "Okänd plats";
        }
        return "Alla platser";
    }
    
    private void ToggleListFilterDropdown()
    {
        listFilterDropdownOpen = !listFilterDropdownOpen;
    }
    
    private void CloseListFilterDropdown()
    {
        listFilterDropdownOpen = false;
    }
    
    private void SelectListFilter(Guid? placeId, Guid? areaId)
    {
        if (areaId.HasValue && placeId.HasValue)
        {
            UI.SelectedListFilterAreaId = areaId.Value;
            UI.SelectedListFilterPlaceId = placeId.Value;
        }
        else if (placeId.HasValue)
        {
            UI.SelectedListFilterPlaceId = placeId.Value;
            UI.SelectedListFilterAreaId = null;
        }
        else
        {
            UI.SelectedListFilterPlaceId = null;
            UI.SelectedListFilterAreaId = null;
        }
        listFilterDropdownOpen = false;
        UI.RaiseChanged();
    }
    
    private class AreaTreeNode
    {
        public Area Area { get; set; } = null!;
        public List<AreaTreeNode> Children { get; set; } = new();
    }
    
    private List<AreaTreeNode> BuildAreaTree(List<Area> areas)
    {
        var idToNode = areas.ToDictionary(a => a.Id, a => new AreaTreeNode { Area = a });
        var roots = new List<AreaTreeNode>();
        
        foreach (var area in areas)
        {
            if (area.ParentAreaId is Guid parentId && idToNode.TryGetValue(parentId, out var parent))
            {
                parent.Children.Add(idToNode[area.Id]);
            }
            else
            {
                roots.Add(idToNode[area.Id]);
            }
        }
        
        return roots.OrderBy(r => r.Area.Path).ToList();
    }
    
    private RenderFragment RenderAreaTreeNode(AreaTreeNode node, Guid placeId, int indent) => builder =>
    {
        var seq = 0;
        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", $"list-filter-area-option {(UI.SelectedListFilterAreaId == node.Area.Id ? "selected" : "")}");
        builder.AddAttribute(seq++, "style", $"padding-left: {indent}px;");
        builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => SelectListFilter(placeId, node.Area.Id)));
        builder.AddContent(seq++, node.Area.Name);
        builder.CloseElement();
        
        foreach (var child in node.Children.OrderBy(c => c.Area.Path))
        {
            builder.AddContent(seq++, RenderAreaTreeNode(child, placeId, indent + 20));
        }
    };
    
    private async Task PrintListView()
    {
        try
        {
            await JS.InvokeVoidAsync("SchedulerMVP.printListView");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ViewToggleBar] Error printing list view: {ex.Message}");
        }
    }
    
    private async Task ExportToPDF()
    {
        try
        {
            await JS.InvokeVoidAsync("SchedulerMVP.exportListToPDF");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ViewToggleBar] Error exporting to PDF: {ex.Message}");
        }
    }

    public void Dispose()
    {
        UI.OnChanged -= HandleUIStateChanged;
    }

    private async Task ReloadTemplatesForPlace(bool force = false) {
        if (force || templates.Count == 0) {
            templates = await TemplateService.GetTemplatesAsync();
            UI.SelectedTemplateId ??= templates.FirstOrDefault()?.Id;
            StateHasChanged();
        }
    }

    private async Task ToggleView(bool l, bool d, bool r) {
        UI.IsWeekListView = l; UI.IsDayView = d; UI.IsResourceView = r;
        UI.RaiseChanged();
        if (!l && !r) {
            await Task.Delay(50);
            try { await JS.InvokeVoidAsync("SchedulerMVP.scrollToTime", 420); } catch {}
        }
    }

    private void OnTemplateChanged(ChangeEventArgs e) { if (Guid.TryParse(e.Value?.ToString(), out var id)) { UI.SelectedTemplateId = id; UI.RaiseChanged(); } }
    private void NavigateToPreviousWeek() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(-7); UI.RaiseChanged(); }
    private void NavigateToNextWeek() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(7); UI.RaiseChanged(); }
    private void NavigateToPreviousDay() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(-1); UI.RaiseChanged(); }
    private void NavigateToNextDay() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(1); UI.RaiseChanged(); }
    private string GetWeekNumber() => System.Globalization.ISOWeek.GetWeekOfYear(UI.CurrentWeekStart.ToDateTime(TimeOnly.MinValue)).ToString();
    private string GetFormattedDayText() => UI.CurrentWeekStart.ToString("dddd, d MMMM yyyy", new System.Globalization.CultureInfo("sv-SE"));
    private void GoToToday() { UI.CurrentWeekStart = DateOnly.FromDateTime(DateTime.Today); UI.RaiseChanged(); }
    private int GetCurrentDayOfWeekForSchedule() { var d = (int)UI.CurrentWeekStart.DayOfWeek; return d == 0 ? 7 : d; }
    private void SetCurrentDayForSchedule(int d) { 
        var start = UI.CurrentWeekStart; var diff = (int)start.DayOfWeek; if (diff == 0) diff = 7;
        UI.CurrentWeekStart = start.AddDays(-(diff - 1)).AddDays(d - 1); UI.RaiseChanged();
    }
    private string GetFormattedDayNameWeekSchedule() => GetCurrentDayOfWeekForSchedule() switch { 1=>"Måndag", 2=>"Tisdag", 3=>"Onsdag", 4=>"Torsdag", 5=>"Fredag", 6=>"Lördag", 7=>"Söndag", _=>"" };
    private void NavigateToPreviousDayWeekSchedule() { SetCurrentDayForSchedule(GetCurrentDayOfWeekForSchedule() == 1 ? 7 : GetCurrentDayOfWeekForSchedule() - 1); }
    private void NavigateToNextDayWeekSchedule() { SetCurrentDayForSchedule(GetCurrentDayOfWeekForSchedule() == 7 ? 1 : GetCurrentDayOfWeekForSchedule() + 1); }
    private void ToggleMoreMenu() => moreMenuOpen = !moreMenuOpen;
    private void CloseMoreMenu() => moreMenuOpen = false;
    private void OpenEdit() { moreMenuOpen = false; editOpen = true; }
    private void OpenCreate() { moreMenuOpen = false; createOpen = true; }
    private void OpenCopy() { moreMenuOpen = false; copyOpen = true; }
    private void OpenShareModal() { moreMenuOpen = false; shareModalOpen = true; }
    private Task CloseEdit() { editOpen = false; return Task.CompletedTask; }
    private Task CloseCreate() { createOpen = false; return Task.CompletedTask; }
    private Task CloseCopy() { copyOpen = false; return Task.CompletedTask; }
    private Task CloseShareModal() { shareModalOpen = false; return Task.CompletedTask; }
    private async Task AfterTemplateSaved() { await ReloadTemplatesForPlace(true); UI.RaiseChanged(); }
    private void OpenPublishModal() { moreMenuOpen = false; publishModalOpen = true; }
    private void ClosePublishModal() => publishModalOpen = false;
    private async Task CopyWeekToClipboard() 
    { 
        moreMenuOpen = false;
        var weekStart = UI.CurrentWeekStart;
        var bookings = await CalendarBookingService.GetBookingsForWeekAsync(weekStart);
        UI.ClipboardWeek = bookings.ToList();
        UI.ClipboardWeekStart = weekStart;
        UI.RaiseChanged();
    }
    
    private async Task PasteWeekFromClipboard() 
    { 
        if (!CanPasteWeek() || UI.ClipboardWeek == null || !UI.ClipboardWeekStart.HasValue) return;
        
        moreMenuOpen = false;
        var targetWeekStart = UI.CurrentWeekStart;
        var sourceWeekStart = UI.ClipboardWeekStart.Value;
        var deltaDays = targetWeekStart.DayNumber - sourceWeekStart.DayNumber;
        
        foreach (var src in UI.ClipboardWeek)
        {
            // Calculate new date: preserve the day of week from source, but adjust to target week
            var sourceDayOfWeek = src.Date.DayOfWeek == DayOfWeek.Sunday ? 7 : (int)src.Date.DayOfWeek;
            var newDate = targetWeekStart.AddDays(sourceDayOfWeek - 1);
            
            await CalendarBookingService.CreateBookingAsync(new CalendarBooking
            {
                Id = Guid.NewGuid(),
                AreaId = src.AreaId,
                GroupId = src.GroupId,
                Date = newDate,
                StartMin = src.StartMin,
                EndMin = src.EndMin,
                Notes = src.Notes,
                SourceTemplateId = src.SourceTemplateId,
                ContactName = src.ContactName,
                ContactEmail = src.ContactEmail,
                ContactPhone = src.ContactPhone,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
        }
        
        // Trigger refresh in WeekGrid
        UI.ForceRefresh = true;
        UI.RaiseChanged();
    }
    
    private bool CanPasteWeek() => UI.IsCalendarViewMode && UI.ClipboardWeek != null && UI.ClipboardWeek.Count > 0 && UI.ClipboardWeekStart.HasValue;
    
    private void OpenCopyTemplateModal() { moreMenuOpen = false; UI.ShouldOpenCopyTemplateModal = true; UI.RaiseChanged(); }
    
    private async Task OpenClearWeekConfirm() 
    { 
        moreMenuOpen = false;
        var weekStart = UI.CurrentWeekStart;
        var bookings = await CalendarBookingService.GetBookingsForWeekAsync(weekStart);
        var count = bookings.Count;
        clearWeekConfirmText = count > 0 
            ? $"Vill du ta bort {count} bokningar från veckan? Denna åtgärd kan inte ångras."
            : "Det finns inga bokningar att ta bort denna vecka.";
        clearWeekConfirmOpen = true;
        StateHasChanged();
    }
    
    private void CloseClearWeekConfirm()
    {
        clearWeekConfirmOpen = false;
        clearWeekConfirmText = string.Empty;
    }
    
    private async Task ConfirmClearWeek()
    {
        var weekStart = UI.CurrentWeekStart;
        var bookings = await CalendarBookingService.GetBookingsForWeekAsync(weekStart);
        foreach (var booking in bookings)
        {
            await CalendarBookingService.DeleteBookingAsync(booking.Id);
        }
        clearWeekConfirmOpen = false;
        clearWeekConfirmText = string.Empty;
        
        // Trigger refresh in WeekGrid
        UI.ForceRefresh = true;
        UI.RaiseChanged();
        StateHasChanged();
    }
}
