@using SchedulerMVP.Services
@inject ToastService ToastService
@implements IDisposable

<div class="toast-container">
    @foreach (var toast in activeToasts)
    {
        <div class="toast toast-@toast.Type.ToString().ToLower()" data-toast-id="@toast.Id">
            <div class="toast-icon">
                @if (toast.Type == ToastType.Success)
                {
                    <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="11" fill="#2E8540"/>
                        <path d="M8 11L10 13L14 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                }
                else if (toast.Type == ToastType.Error)
                {
                    <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="11" fill="#DC2626"/>
                        <path d="M8 8L14 14M14 8L8 14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                }
                else
                {
                    <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="11" fill="#1761A5"/>
                        <path d="M11 7V11M11 15H11.01" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                }
            </div>
            <div class="toast-content">
                <div class="toast-title">@toast.Title</div>
                @if (!string.IsNullOrWhiteSpace(toast.Message))
                {
                    <div class="toast-message">@toast.Message</div>
                }
            </div>
            <button class="toast-close" @onclick="() => DismissToast(toast.Id)" aria-label="StÃ¤ng">
                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 6L6 16M6 6L16 16" stroke="#63768B" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
    }
</div>

<style>
    .toast-container {
        position: fixed;
        bottom: 24px;
        left: 0;
        right: 0;
        z-index: 10000;
        display: flex;
        flex-direction: column-reverse;
        gap: 12px;
        align-items: center;
        pointer-events: none;
        max-width: 100vw;
    }
    
    .toast {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 12px;
        border-radius: 4px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        pointer-events: all;
        min-width: 300px;
        max-width: 500px;
        animation: toast-slide-in 0.3s ease-out forwards;
    }
    
    .toast-success {
        background-color: #CBF4C9;
        border: 1px solid rgba(46, 133, 64, 0.1);
    }
    
    .toast-error {
        background-color: #FEE2E2;
        border: 1px solid rgba(220, 38, 38, 0.1);
    }
    
    .toast-info {
        background-color: #DBEAFE;
        border: 1px solid rgba(23, 97, 165, 0.1);
    }
    
    .toast-icon {
        flex-shrink: 0;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .toast-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-width: 0;
    }
    
    .toast-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 12px;
        font-weight: 500;
        line-height: 16px;
        letter-spacing: 0.1px;
        color: #213142;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .toast-message {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 10px;
        font-weight: 400;
        line-height: 16px;
        color: #63768B;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .toast-close {
        flex-shrink: 0;
        width: 22px;
        height: 22px;
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    
    .toast-close:hover {
        opacity: 1;
    }
</style>

@code {
    private List<ToastMessage> activeToasts = new();
    private Dictionary<Guid, Timer> toastTimers = new();
    
    protected override void OnInitialized()
    {
        ToastService.OnShowToast += ShowToast;
    }
    
    private void ShowToast(ToastMessage toast)
    {
        activeToasts.Add(toast);
        InvokeAsync(StateHasChanged);
        
        // Auto-dismiss after 5 seconds
        var timer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                DismissToast(toast.Id);
            });
        }, null, 5000, Timeout.Infinite);
        
        toastTimers[toast.Id] = timer;
    }
    
    private void DismissToast(Guid toastId)
    {
        activeToasts.RemoveAll(t => t.Id == toastId);
        
        // Clean up timer
        if (toastTimers.TryGetValue(toastId, out var timer))
        {
            timer?.Dispose();
            toastTimers.Remove(toastId);
        }
        
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        ToastService.OnShowToast -= ShowToast;
        
        // Clean up all timers
        foreach (var timer in toastTimers.Values)
        {
            timer?.Dispose();
        }
        toastTimers.Clear();
    }
}

