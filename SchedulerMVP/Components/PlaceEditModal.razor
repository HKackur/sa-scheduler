@inject SchedulerMVP.Services.IPlaceService PlaceService
@inject SchedulerMVP.Services.UIState UI

@if (IsOpen && PlaceId.HasValue)
{
    <div class="modal-container" @onclick="OnBackdrop">
        <div class="bm-modal" @onclick:stopPropagation="true">
            <div class="bm-header">
                <h2 class="bm-title">Redigera plats</h2>
            </div>
            <div class="bm-field">
                <label class="bm-label">Platsnamn</label>
                <input class="bm-input" value="@name" @oninput="OnNameInput" placeholder="Ange platsnamn" />
            </div>
            <div class="bm-field">
                <label class="bm-label">Standard längd på bokning</label>
                <div class="bm-inline">
                    <input class="bm-input bm-w-full" value="@durationText" @oninput="OnDurationInput" type="number" min="1" />
                    <span class="bm-suffix">min</span>
                </div>
            </div>
            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div style="color: #dc2626; font-size: 12px; padding: 8px; background: #fee2e2; border-radius: 4px;">
                    @errorMessage
                </div>
            }
            <div class="bm-actions">
                <button type="button" @onclick="OnDelete" class="btn-danger-left">Ta bort</button>
                <div style="margin-left:auto;display:flex;gap:12px;">
                    <button type="button" @onclick="OnCancel" class="btn-outline">Avbryt</button>
                    <button type="button" @onclick="OnSave" class="btn-primary" disabled="@(string.IsNullOrWhiteSpace(name) || isLoading)">Spara</button>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* Match ScheduleTemplateEditModal exact structure and styling */
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px 28px 0 28px;border:1px solid #e6e7ea;border-radius:12px;min-width:560px;max-width:720px;width:90vw;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
        .bm-header{position:sticky;top:0;background:#fff;z-index:12;padding-bottom:12px;margin-bottom:0}
        .bm-input{width:100%;padding:10px 12px;border-radius:4px;border:1px solid #dcdee2;background-color:#f3f5f7;box-shadow:0 2px 8px 0 rgba(0,0,0,0.02);font-size:12px;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;box-sizing:border-box;min-height:40px}
        .bm-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
        .bm-w-full{width:100%}
        .bm-inline{display:flex;align-items:center;gap:8px}
        .bm-suffix{font-size:14px;color:#6b7280;white-space:nowrap}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px;position:sticky;bottom:0;background:#fff;padding-top:12px;padding-bottom:24px;z-index:10}
    </style>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public Guid? PlaceId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }

    private string name = string.Empty;
    private string durationText = "90";
    private SchedulerMVP.Data.Entities.Place? place;
    private bool isLoading = false;
    private string? errorMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && PlaceId.HasValue)
        {
            await LoadPlace();
        }
        else if (!IsOpen)
        {
            // Reset state when modal closes
            place = null;
            name = string.Empty;
            durationText = "90";
            isLoading = false;
            errorMessage = null;
        }
    }

    private async Task LoadPlace()
    {
        if (!PlaceId.HasValue)
        {
            return;
        }
        
        isLoading = true;
        StateHasChanged();
        
        try
        {
            place = await PlaceService.GetPlaceAsync(PlaceId.Value);
            if (place != null)
            {
                name = place.Name;
                durationText = place.DefaultDurationMin.ToString();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[PlaceEditModal] Error loading place: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnNameInput(ChangeEventArgs e)
    {
        name = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }
    
    private void OnDurationInput(ChangeEventArgs e)
    {
        durationText = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private async Task OnSave()
    {
        Console.WriteLine("[PlaceEditModal] OnSave called");
        
        await InvokeAsync(async () =>
        {
            errorMessage = null;
            StateHasChanged();
            
            // Validate place is loaded
            if (place == null || !PlaceId.HasValue)
            {
                errorMessage = "Platsen kunde inte laddas. Försök igen.";
                Console.WriteLine("[PlaceEditModal] Place is null or PlaceId is null, cannot save");
                StateHasChanged();
                return;
            }
            
            // Validate name
            if (string.IsNullOrWhiteSpace(name))
            {
                errorMessage = "Platsnamn får inte vara tomt.";
                Console.WriteLine("[PlaceEditModal] Name is empty, cannot save");
                StateHasChanged();
                return;
            }
            
            // Validate duration
            if (!int.TryParse(durationText, out var duration) || duration < 1)
            {
                errorMessage = "Standard längd måste vara ett positivt heltal.";
                Console.WriteLine($"[PlaceEditModal] Invalid duration: {durationText}");
                StateHasChanged();
                return;
            }
            
            try
            {
                Console.WriteLine($"[PlaceEditModal] Attempting to save: Id={place.Id}, Name={name.Trim()}, Duration={duration}");
                
                // Update place properties
                place.Name = name.Trim();
                place.DefaultDurationMin = duration;
                
                // Save to database
                var updatedPlace = await PlaceService.UpdatePlaceAsync(place);
                
                Console.WriteLine($"[PlaceEditModal] Place saved successfully: {updatedPlace.Name}");
                
                // Clear error message
                errorMessage = null;
                
                // Close modal first
                IsOpen = false;
                StateHasChanged();
                
                // Trigger close callback
                if (OnClose.HasDelegate)
                {
                    await OnClose.InvokeAsync();
                }
                
                // Then trigger saved callback
                if (OnSaved.HasDelegate)
                {
                    await OnSaved.InvokeAsync();
                }
            }
            catch (UnauthorizedAccessException ex)
            {
                errorMessage = "Du har inte behörighet att uppdatera denna plats.";
                Console.WriteLine($"[PlaceEditModal] Unauthorized: {ex.Message}");
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorMessage = $"Ett fel uppstod vid sparning: {ex.Message}";
                Console.WriteLine($"[PlaceEditModal] Error saving place: {ex.Message}");
                Console.WriteLine($"[PlaceEditModal] Exception type: {ex.GetType().Name}");
                Console.WriteLine($"[PlaceEditModal] Stack trace: {ex.StackTrace}");
                StateHasChanged();
            }
        });
    }

    private async Task OnDelete()
    {
        if (place == null)
        {
            return;
        }
        
        try
        {
            await PlaceService.DeletePlaceAsync(place.Id);
            
            await CloseAsync();
            await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[PlaceEditModal] Error deleting place: {ex.Message}");
        }
    }

    private async Task OnCancel()
    {
        await CloseAsync();
    }
    
    private async Task OnBackdrop(MouseEventArgs _)
    {
        await CloseAsync();
    }

    private async Task CloseAsync()
    {
        IsOpen = false;
        StateHasChanged();
        
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }
}
