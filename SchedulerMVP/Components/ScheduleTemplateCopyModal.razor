@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI

@if (IsOpen)
{
    <div class="modal-container" @onclick="OnBackdrop">
        <div class="bm-modal" @onclick:stopPropagation="true">
        <h3 class="bm-title">Skapa kopia</h3>
        <div class="bm-field">
            <label class="bm-label">Mallnamn</label>
            <input class="tb-select" value="@name" @oninput="OnNameInput" placeholder="Ange namn" />
        </div>
        <div class="bm-actions">
            <button type="button" @onclick="OnCancel" class="btn-outline">Avbryt</button>
            <button type="button" @onclick="OnCopy" class="btn-primary" disabled="@string.IsNullOrWhiteSpace(name)">Spara</button>
        </div>
        </div>
    </div>
    <style>
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px;border:1px solid #e6e7ea;border-radius:12px;min-width:560px;max-width:720px;width:90vw;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto}
        .bm-title{margin:0 0 20px 0;font-size:28px;font-weight:800;letter-spacing:-.02em}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
        .btn-outline,.btn-primary{padding:8px 16px;border-radius:10px;font-size:13px;line-height:20px;min-height:40px;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;transition:background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease}
        .btn-outline{border:1px solid #d1d5db;background:#fff;color:#0f1720}
        .btn-outline:hover{background:#f1f5f9;box-shadow:0 0 0 2px rgba(99,102,241,0.1)}
        .btn-outline:active{transform:translateY(1px);}
        .btn-primary{border:none;background:#0b1e34;color:#fff}
        .btn-primary:hover:not(:disabled){background:#081326;box-shadow:0 0 0 2px rgba(11,30,52,0.2)}
        .btn-primary:active:not(:disabled){transform:translateY(1px);}
        .btn-primary:disabled{opacity:0.6;cursor:not-allowed;box-shadow:none}
    </style>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnCopied { get; set; }

    private string name = string.Empty;
    private string originalTemplateName = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && UI.SelectedTemplateId is Guid templateId)
        {
            var template = await TemplateService.GetByIdAsync(templateId);
            if (template != null)
            {
                originalTemplateName = template.Name;
                name = $"Kopia av {originalTemplateName}";
            }
        }
    }

    private void OnNameInput(ChangeEventArgs e) => name = e.Value?.ToString() ?? string.Empty;

    private async Task OnCopy()
    {
        if (UI.SelectedTemplateId is Guid templateId && !string.IsNullOrWhiteSpace(name))
        {
            var clone = await TemplateService.SaveAsNewAsync(templateId, name);
            UI.SelectedTemplateId = clone.Id;
            await OnCopied.InvokeAsync();
            await CloseAsync();
        }
    }

    private async Task OnCancel() => await CloseAsync();
    private async Task OnBackdrop(MouseEventArgs _) => await CloseAsync();

    private async Task CloseAsync()
    {
        IsOpen = false;
        await OnClose.InvokeAsync();
    }
}
