@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using SchedulerMVP.Data.Entities
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components
@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI
@inject SchedulerMVP.Services.ICalendarBookingService CalendarBookingService
@inject SchedulerMVP.Services.IPlaceService PlaceService
@inject IDbContextFactory<SchedulerMVP.Data.AppDbContext> DbFactory
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

@{
    var uri = Navigation.Uri.ToLower();
    var path = new Uri(uri).AbsolutePath.ToLower();
    var isLoginPage = path == "/login" || path.EndsWith("/login");
    var isAdminPage = UI.IsAdminPage || path == "/admin" || path.EndsWith("/admin") || path.Contains("/admin/");
    var isGroupsManagePage = path == "/grupper" || path.EndsWith("/grupper");
}

@if (!isLoginPage)
{
    <div class="sa-topbar">
    <div class="sa-topbar-row">
        @* Left column: 80% width - matches .sa-center-new *@
        <div class="tb-topbar-left">
            @if (isAdminPage || isGroupsManagePage)
            {
                <div class="sa-header-content">
                    <button class="btn-nav" @onclick="NavigateBack" title="Tillbaka">
                        <span class="material-symbols-outlined">chevron_left</span>
                        Tillbaka
                    </button>
                    <h2 class="sa-page-title">@(isAdminPage ? "Admin" : "Hantera grupper")</h2>
                </div>
            }
            else
            {
                <div class="sa-header-content">
                    <h2 class="sa-page-title">@UI.PageTitle</h2>
                    @if (UI.SelectedAreaId.HasValue && selectedAreaCache != null && selectedAreaCache.Id == UI.SelectedAreaId.Value)
                    {
                        <div class="sa-breadcrumb">
                            @{
                                var breadcrumbItems = GetBreadcrumbPath(selectedAreaCache);
                            }
                            @for (int i = 0; i < breadcrumbItems.Count; i++)
                            {
                                var item = breadcrumbItems[i];
                                var isLast = i == breadcrumbItems.Count - 1;
                                <span class="sa-breadcrumb-item @(isLast ? "sa-breadcrumb-current" : "")" 
                                      @onclick="@(() => NavigateBreadcrumb(item))">
                                    @item.Name
                                </span>
                                @if (!isLast)
                                {
                                    <span class="sa-breadcrumb-separator">/</span>
                                }
                            }
                        </div>
                    }
                </div>
                
                @* Calendar actions container *@
                @if (UI.IsCalendarViewMode)
                {
                    <div class="calendar-actions">
                    <!-- Navigation group -->
                    <div class="nav-group">
                            <button class="btn btn-today" @onclick="GoToToday" title="Gå till idag">Idag</button>
                            
                            @if (UI.IsDayView)
                            {
                                <button class="btn btn-nav" @onclick="NavigateToPreviousDay" title="Föregående dag">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>
                                <button class="btn btn-nav" @onclick="NavigateToNextDay" title="Nästa dag">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                                <div class="nav-text">@GetFormattedDayText()</div>
                            }
                            else
                            {
                                <button class="btn btn-nav" @onclick="NavigateToPreviousWeek" title="Föregående vecka">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                </button>
                                <button class="btn btn-nav" @onclick="NavigateToNextWeek" title="Nästa vecka">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                </button>
                                <div class="nav-text">Vecka @GetWeekNumber()</div>
                            }
                        </div>
                        
                        <!-- View controls and more options group -->
                        <div class="view-controls-group">
                            <!-- Week/Day select container -->
                            <div class="select-group">
                                <select class="tb-select" @onchange="OnViewModeChanged">
                                    <option value="false" selected="@(!UI.IsDayView)">Vecka</option>
                                    <option value="true" selected="@(UI.IsDayView)">Dag</option>
                                </select>
                            </div>
                            
                            <!-- More options container -->
                            <div class="more-group">
                                <div style="position: relative;">
                                    <button class="tb-btn" @onclick="ToggleMoreMenu" title="Fler alternativ">
                                        Fler alternativ <span class="material-symbols-outlined" style="font-size: 18px; margin-left: 4px;">more_vert</span>
                                    </button>
                                    @if (moreMenuOpen)
                                    {
                                        <div class="menu-overlay" @onclick="CloseMoreMenu"></div>
                                        <div class="tb-menu" style="right: 0; left: auto;">
                                            <button class="tb-item" @onclick="OpenCopyTemplateModal">Lägg till från mall</button>
                                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                                            <button class="tb-item" @onclick="OpenClearWeekConfirm">Rensa vecka</button>
                                            <button class="tb-item" @onclick="CopyWeekToClipboard">Kopiera vecka till urklipp</button>
                                            <button class="tb-item" @onclick="PasteWeekFromClipboard" disabled="@(!CanPasteWeek())">Klistra in vecka</button>
                                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                                            <button class="tb-item" disabled>Publicera till närvarokorten</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Template selector and actions for week planning view -->
                    <div class="calendar-actions">
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:nowrap;white-space:nowrap;">
                            <select class="tb-select" @onchange="OnTemplateChanged">
                                @foreach (var t in templates)
                                {
                                    <option value="@t.Id" selected="@(UI.SelectedTemplateId == t.Id)">@t.Name</option>
                                }
                            </select>
                            <button class="tb-action-btn" @onclick="OpenEdit" title="Ändra mallen">
                                <span class="action-text">Ändra mallen</span>
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <div style="position: relative;">
                                <button class="tb-action-btn" @onclick="ToggleMenu" title="Mallåtgärder">
                                    <span class="action-text">Ny mall</span>
                                    <span class="material-symbols-outlined">add</span>
                                </button>
                                @if (menuOpen)
                                {
                                    <div class="menu-overlay" @onclick="CloseMenu"></div>
                                    <div class="tb-menu">
                                        <button class="tb-item" @onclick="OpenCreate">Ny mall</button>
                                        <button class="tb-item" @onclick="OpenCopy">Skapa kopia</button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
        
        @* Right column: 20% width - matches .sa-right-new - Only view toggle *@
        <div class="tb-topbar-right">
            @if (!isAdminPage && !isGroupsManagePage)
            {
                @* View toggle tabs *@
                <div class="view-toggle">
                    <button class="view-toggle-btn @(UI.IsCalendarViewMode ? "" : "active")" @onclick="SwitchToWeekPlanner">Veckoschema</button>
                    <button class="view-toggle-btn @(UI.IsCalendarViewMode ? "active" : "")" @onclick="SwitchToCalendar">Kalender</button>
                </div>
            }

            @* User menu *@
            <div style="position: relative; margin-left: 12px;">
                <button class="btn-nav" @onclick="ToggleUserMenu" title="Meny" aria-label="Meny">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <rect x="3" y="6" width="18" height="2" rx="1" fill="#000"/>
                        <rect x="3" y="11" width="18" height="2" rx="1" fill="#000"/>
                        <rect x="3" y="16" width="18" height="2" rx="1" fill="#000"/>
                    </svg>
                </button>
                @if (userMenuOpen)
                {
                    <div class="menu-overlay" @onclick="CloseUserMenu"></div>
                    <div class="tb-menu" style="right:0; left:auto; min-width:220px;">
                        <div class="tb-item user-email">@currentUserEmail</div>
                        <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                        @if (isCurrentUserAdmin)
                        {
                            <a href="/admin" class="tb-item" style="text-decoration:none;" @onclick="NavigateToAdminLink">Admin</a>
                        }
                        <a href="/grupper" class="tb-item" style="text-decoration:none;" @onclick="NavigateToGroupsLink">Hantera grupper</a>
                        <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                        <button class="tb-item danger" @onclick="PerformLogout">Logga ut</button>
                    </div>
                }
            </div>
        </div>
    </div>
    

    <style>
        .sa-header-content {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 0 0 auto;
            margin-right: auto;
            max-width: fit-content;
        }

        .sa-page-title {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .sa-breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #6b7280;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .sa-breadcrumb-item {
            font-weight: 500;
        }
        
        .sa-breadcrumb-item:not(.sa-breadcrumb-current) {
            cursor: pointer;
            text-decoration: underline;
            color: #4b5563;
        }
        
        .sa-breadcrumb-item:not(.sa-breadcrumb-current):hover {
            color: #1f2937;
            text-decoration: underline;
        }

        .sa-breadcrumb-current {
            color: #374151;
            font-weight: 600;
        }

        .sa-breadcrumb-separator {
            color: #9ca3af;
            font-weight: 400;
        }
        
        .view-toggle{display:flex;background:#f1f5f9;border-radius:8px;padding:2px}
        .view-toggle-btn{border:none;background:transparent;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:500;color:#64748b;cursor:pointer;transition:all 0.2s;height:34px;box-sizing:border-box;display:flex;align-items:center}
        .view-toggle-btn:hover{color:#334155}
        .view-toggle-btn.active{background:#fff;color:#0f172a;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
        
        .select-group {
            display: flex;
            align-items: center;
            min-width: 120px; /* Ensure select has minimum width to display content */
            flex-shrink: 0;
        }
        
        /* Top bar selects - reduce padding to match button height */
        .sa-topbar .tb-select {
            padding: 7px 12px; /* Reduced from 10px to 7px top/bottom for 34px height */
        }
        
        /* Week template selector: fixed width with truncation and spacing before arrow */
        .calendar-actions > div > select.tb-select {
            width: 220px;            /* standard fixed width */
            min-width: 220px;
            max-width: 280px;
            padding-right: 36px;    /* leave gap before the arrow icon */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* truncate long template titles */
            flex: 0 0 auto;          /* prevent shrinking in flex row */
        }
        
        
        /* Calendar actions container - FIXED layout */
        .calendar-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
            flex-wrap: nowrap;
            flex-shrink: 1 !important;
            min-width: 0 !important;
        }
        
        /* Inner container for buttons/select */
        .calendar-actions > div {
            display: flex !important;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap !important;
            white-space: nowrap !important;
            flex-shrink: 1 !important;
            min-width: 0 !important;
        }
        
        .sa-topbar-row {
            display: flex;
            align-items: center;
            gap: 0;
            flex-wrap: nowrap;
            min-width: 0;
        }
        
        /* Top bar columns matching main layout */
        .tb-topbar-left {
            flex: 0 0 80%;
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 0;
            padding-right: 16px;
        }
        
        .tb-topbar-right {
            flex: 0 0 20%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 0;
            padding-right: 24px; /* Match left padding from .sa-topbar */
        }
        
        .view-controls-group {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        /* Navigation group - left aligned */
        .nav-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Toggle group - centered */
        .toggle-group {
            display: flex;
            align-items: center;
        }
        
        /* More options group - right aligned */
        .more-group {
            display: flex;
            align-items: center;
        }
        
        .nav-text {
            font-weight: 500;
            color: #333;
            margin: 0 8px;
            min-width: 200px; /* Ensure enough space for date text */
            white-space: nowrap; /* Prevent line breaks */
            text-align: left; /* Left-align the date text */
        }
        
        .today-highlight {
            background: #1761A5;
            color: #FFF;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .btn {
            display: inline-flex;
            padding: 8px 12px;
            align-items: center;
            gap: 12px;
            border: none;
            border-radius: 6px;
            background: #eeeeee;
            color: var(--Base-Black, #000);
            text-align: center;
            font-feature-settings: 'liga' off, 'clig' off;
            font-family: Inter;
            font-size: 12px;
            font-style: normal;
            font-weight: 500;
            line-height: 16px;
            cursor: pointer;
            transition: all 0.2s;
            height: 34px;
            box-sizing: border-box;
        }
        
        .btn:hover {
            background: #e4e4e4;
        }
        
        .btn:focus {
            background: #eeeeee;
            border: 1px solid #cfcfcf;
            outline: none;
        }
        
        
        .btn-outline-secondary {
            background: transparent;
            border-color: #d1d5db;
            color: #6b7280;
        }
        
        .btn-outline-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            color: #374151;
        }
        
        .btn-today {
            display: inline-flex;
            padding: 8px 16px;
            align-items: center;
            gap: 12px;
            border: none;
            border-radius: 6px;
            background: #eeeeee;
            color: var(--Base-Black, #000);
            text-align: center;
            font-feature-settings: 'liga' off, 'clig' off;
            font-family: Inter;
            font-size: 12px;
            font-style: normal;
            font-weight: 500;
            line-height: 16px;
            cursor: pointer;
            transition: all 0.2s;
            height: 34px;
            box-sizing: border-box;
        }
        
        .btn-today:hover {
            background: #e4e4e4;
        }
        
        .btn-today:focus {
            background: #eeeeee;
            border: 1px solid #cfcfcf;
            outline: none;
        }
        
        
        .btn-nav {
            display: inline-flex;
            padding: 8px 8px;
            align-items: center;
            gap: 12px;
            border: none;
            border-radius: 6px;
            background: #eeeeee;
            color: var(--Base-Black, #000);
            text-align: center;
            font-feature-settings: 'liga' off, 'clig' off;
            font-family: Inter;
            font-size: 12px;
            font-style: normal;
            font-weight: 500;
            line-height: 16px;
            cursor: pointer;
            transition: all 0.2s;
            justify-content: center;
            min-width: 32px;
            height: 34px;
            box-sizing: border-box;
        }
        
        .btn-nav:hover {
            background: #e4e4e4;
        }
        
        .btn-nav:focus {
            background: #eeeeee;
            border: 1px solid #cfcfcf;
            outline: none;
        }
        
        
        .btn-nav .material-symbols-outlined {
            font-size: 18px;
        }
        
        /* Template selector and actions styling */
        .sa-topbar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
        }
        
        
        /* Input container structure */
        .input-container {
            display: flex;
            width: 200px;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            flex-shrink: 0;
        }
        
        /* Input label */
        .input-label {
            color: var(--Base-Black, #000);
            font-feature-settings: 'liga' off, 'clig' off;
            font-family: Inter;
            font-size: 11px;
            font-style: normal;
            font-weight: 400;
            line-height: 16px; /* 145.455% */
        }
        
        /* Action button design */
        .tb-action-btn {
            display: inline-flex;
            padding: 6px 12px;
            align-items: center;
            gap: 8px;
            border-radius: 4px;
            background: var(--gray-primary-gray-300, #EEE);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            min-width: max-content;
            width: auto;
            height: 34px;
            box-sizing: border-box;
        }
        
        .tb-action-btn:hover {
            background: #ddd;
        }
        
        .action-text {
            color: var(--Base-Black, #000);
            text-align: center;
            font-feature-settings: 'liga' off, 'clig' off;
            font-family: Inter;
            font-size: 12px;
            font-style: normal;
            font-weight: 500;
            line-height: 16px; /* 133.333% */
            white-space: nowrap;
        }
        
        .tb-action-btn .material-symbols-outlined {
            font-size: 18px;
            color: var(--Base-Black, #000);
        }
        
        .tb-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;             /* anchor to the right edge so it opens leftwards */
            left: auto;
            background: white;
            border: 1px solid #e4e4e4;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: max-content;   /* grow to fit content */
            max-width: 280px;     /* but never wider than 280px */
            min-width: fit-content; /* avoid breaking too early */
            padding: 8px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow-x: hidden;   /* never overflow horizontally */
        }
        
        .tb-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            background: transparent;
            text-align: right;
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: normal;   /* allow wrapping */
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        
        .tb-item:hover {
            background: #f3f4f6;
        }
        .tb-item:disabled {
            color: #9ca3af;
            cursor: not-allowed;
            background: transparent;
            opacity: 0.7;
        }
        
        .tb-item.danger {
            color: #dc2626;
        }
        
        .tb-item.danger:hover {
            background: #fef2f2;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            background: transparent;
        }
        
        .tb-btn {
            display: inline-flex;
            padding: 8px 12px;
            align-items: center;
            gap: 8px;
            border: none;
            border-radius: 6px;
            background: #1761A5;
            color: #FFF;
            text-align: center;
            white-space: nowrap; /* Prevent line breaks */
            flex-shrink: 0; /* Prevent shrinking */
            font-feature-settings: 'liga' off, 'clig' off;
            font-family: Inter;
            font-size: 12px;
            font-style: normal;
            font-weight: 500;
            line-height: 16px;
            cursor: pointer;
            transition: all 0.2s;
            height: 34px;
            box-sizing: border-box;
        }
        
        .tb-btn:hover {
            background: #0f4a7a;
        }
        
        .tb-btn:focus {
            background: #1761A5;
            border: none;
            outline: none;
        }
        
        .tb-item.user-email {
            color: #6b7280;
            font-size: 13px;
            justify-content: flex-start;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-all;
            cursor: default;
        }
        
        .tb-item.user-email:hover {
            background: transparent;
        }
        
    </style>
</div>
}
@* End @if (!isLoginPage) - TopBar only shows when NOT on login page *@

<ScheduleTemplateEditModal IsOpen="@editOpen" OnClose="CloseEdit" OnSaved="AfterTemplateSaved" OnDeleteRequested="OpenDeleteFromEdit" />
<ScheduleTemplateCreateModal IsOpen="@createOpen" OnClose="CloseCreate" OnCreated="AfterTemplateSaved" />
<ScheduleTemplateCopyModal IsOpen="@copyOpen" OnClose="CloseCopy" OnCopied="AfterTemplateSaved" />
<ScheduleTemplateDeleteModal IsOpen="@deleteOpen" OnClose="CloseDelete" OnDeleted="AfterTemplateSaved" />
@* ONBOARDING DISABLED - Commented out to ensure login works 100% *@
@* <Onboarding /> *@

@code {
    private List<SchedulerMVP.Data.Entities.ScheduleTemplate> templates = new();
    private bool menuOpen;
    private bool editOpen;
    private bool createOpen;
    private bool copyOpen;
    private bool deleteOpen;
    private Guid? lastPlaceId;
    
    // Calendar navigation fields
    private bool moreMenuOpen;
    private bool clearWeekConfirmOpen;
    private string clearWeekConfirmText = "";
    private bool userMenuOpen;
    private string? currentUserEmail;
    private bool isCurrentUserAdmin;
    
    // SelectedArea for breadcrumb - cached and loaded async
    private Area? selectedAreaCache;
    
    private Area? SelectedArea
    {
        get
        {
            // Return cached value if available and still valid
            if (selectedAreaCache != null && selectedAreaCache.Id == UI.SelectedAreaId)
                return selectedAreaCache;
            
            // Don't access DbContext in property getter - use async loading instead
            return null;
        }
    }
    
    private async Task LoadSelectedAreaAsync()
    {
        if (UI.SelectedAreaId.HasValue)
        {
            try
            {
                await using var db = await DbFactory.CreateDbContextAsync();
                var area = await db.Areas
                    .Include(a => a.Place)
                    .Include(a => a.ParentArea)
                    .FirstOrDefaultAsync(a => a.Id == UI.SelectedAreaId.Value);
                
                if (area != null)
                {
                    // Load parent areas recursively
                    var current = area.ParentArea;
                    while (current != null)
                    {
                        await db.Entry(current)
                            .Reference(a => a.ParentArea)
                            .LoadAsync();
                        current = current.ParentArea;
                    }
                    
                    selectedAreaCache = area;
                }
                else
                {
                    selectedAreaCache = null;
                }
            }
            catch
            {
                selectedAreaCache = null;
            }
        }
        else
        {
            selectedAreaCache = null;
        }
    }
    
    private class BreadcrumbItem
    {
        public string Name { get; set; } = string.Empty;
        public Guid? PlaceId { get; set; }
        public Guid? AreaId { get; set; }
    }
    
    private List<BreadcrumbItem> GetBreadcrumbPath(Area area)
    {
        var items = new List<BreadcrumbItem>();
        
        // Build path from root to current area
        var path = new List<Area>();
        var current = area;
        while (current != null)
        {
            path.Insert(0, current);
            current = current.ParentArea;
        }
        
        // Add Place
        if (area.Place != null)
        {
            items.Add(new BreadcrumbItem 
            { 
                Name = area.Place.Name, 
                PlaceId = area.Place.Id 
            });
        }
        
        // Add all parent areas and current area
        foreach (var a in path)
        {
            items.Add(new BreadcrumbItem 
            { 
                Name = a.Name, 
                AreaId = a.Id 
            });
        }
        
        return items;
    }
    
    private async Task NavigateBreadcrumb(BreadcrumbItem item)
    {
        if (item.PlaceId.HasValue)
        {
            // Navigate to place - select place and clear area
            UI.SelectedPlaceId = item.PlaceId.Value;
            UI.SelectedAreaId = null;
            UI.RaiseChanged();
            await InvokeAsync(StateHasChanged);
        }
        else if (item.AreaId.HasValue)
        {
            // Navigate to area
            UI.SelectedAreaId = item.AreaId.Value;
            UI.RaiseChanged();
            await InvokeAsync(StateHasChanged);
        }
    }
    
    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        UI.OnChanged += StateHasChanged;
        try
        {
            var user = HttpContextAccessor?.HttpContext?.User;
            currentUserEmail = user?.FindFirstValue(ClaimTypes.Email) ?? user?.Identity?.Name;
            isCurrentUserAdmin = user?.IsInRole("Admin") == true;
        }
        catch { }
    }
    
    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        UI.OnChanged -= StateHasChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        try
        {
            var path = new Uri(e.Location).AbsolutePath.ToLower();
            var isGroups = path == "/grupper" || path.EndsWith("/grupper");
            var isAdmin = path == "/admin" || path.EndsWith("/admin") || path.Contains("/admin/");
            if (isGroups)
            {
                UI.PageTitle = "Hantera grupper";
                UI.IsAdminPage = false;
            }
            else if (isAdmin)
            {
                UI.PageTitle = "Admin";
                UI.IsAdminPage = true;
            }
            else
            {
                // Default scheduler pages
                UI.IsAdminPage = false;
                UI.PageTitle = UI.IsCalendarViewMode ? "Kalender" : "Veckoschema";
            }
        }
        catch { }
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        UI.OnChanged += async () => 
        { 
            try
            {
                await ReloadTemplatesForPlace();
                await LoadSelectedAreaAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Silently handle errors during state changes to prevent crashes
                // The component will refresh on next successful state change
            }
        };
        try
        {
            await ReloadTemplatesForPlace();
            await LoadSelectedAreaAsync();
        }
        catch (Exception ex)
        {
            // Handle initialization errors gracefully
        }

        // Resolve email from Identity if not present as a claim
        try
        {
            if (string.IsNullOrEmpty(currentUserEmail))
            {
                // First try via Cascading AuthenticationState
                var state = await AuthStateProvider.GetAuthenticationStateAsync();
                var principal = state?.User;
                var userId = principal?.FindFirstValue(ClaimTypes.NameIdentifier);
                if (!string.IsNullOrEmpty(userId))
                {
                    var appUser = await UserManager.FindByIdAsync(userId);
                    currentUserEmail = appUser?.Email;
                    try
                    {
                        if (appUser != null)
                            isCurrentUserAdmin = await UserManager.IsInRoleAsync(appUser, "Admin");
                    }
                    catch { isCurrentUserAdmin = false; }
                }
                else
                {
                    // Fallback to HttpContext if available
                    var ctxUser = HttpContextAccessor?.HttpContext?.User;
                    userId = ctxUser?.FindFirstValue(ClaimTypes.NameIdentifier);
                    if (!string.IsNullOrEmpty(userId))
                    {
                        var appUser2 = await UserManager.FindByIdAsync(userId);
                        currentUserEmail = appUser2?.Email;
                        try
                        {
                            if (appUser2 != null)
                                isCurrentUserAdmin = await UserManager.IsInRoleAsync(appUser2, "Admin");
                        }
                        catch { isCurrentUserAdmin = false; }
                    }
                }
            }
        }
        catch { }
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadTemplatesForPlace();
    }


    private async Task ReloadTemplatesForPlace(bool force = false)
    {
        // Load templates globally (independent of current place)
        if (force || templates.Count == 0)
        {
            templates = await TemplateService.GetTemplatesAsync();
            if (UI.SelectedTemplateId is Guid tid)
            {
                if (!templates.Any(t => t.Id == tid))
                {
                    UI.SelectedTemplateId = templates.FirstOrDefault()?.Id;
                }
            }
            else
            {
                UI.SelectedTemplateId = templates.FirstOrDefault()?.Id;
            }
            StateHasChanged();
        }
    }

    private Task OnTemplateChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var id))
        {
            UI.SelectedTemplateId = id;
            UI.RaiseChanged();
        }
        return Task.CompletedTask;
    }

    private void ToggleMenu() => menuOpen = !menuOpen;
    
    private void SwitchToWeekPlanner()
    {
        // PERF: Only trigger refresh if view actually changed
        if (!UI.IsCalendarViewMode) return;
        
        UI.IsCalendarViewMode = false;
        UI.PageTitle = "Veckoschema";
        var today = DateOnly.FromDateTime(DateTime.Today);
        var monday = today.AddDays(-(int)today.DayOfWeek + (int)DayOfWeek.Monday);
        UI.CurrentWeekStart = monday;
        UI.IsDayView = false;
        menuOpen = false;
        
        // Trigger refresh - WeekGrid will load week template data
        UI.RaiseChanged();
    }
    
    private void SwitchToCalendar()
    {
        // PERF: Only trigger refresh if view actually changed
        if (UI.IsCalendarViewMode) return;
        
        UI.IsCalendarViewMode = true;
        UI.PageTitle = "Kalender";
        var today = DateOnly.FromDateTime(DateTime.Today);
        var monday = today.AddDays(-(int)today.DayOfWeek + (int)DayOfWeek.Monday);
        UI.CurrentWeekStart = monday;
        UI.IsDayView = false;
        menuOpen = false;
        
        // Trigger refresh - WeekGrid will load calendar booking data
        UI.RaiseChanged();
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/");
    }

    private void NavigateToAdminLink()
    {
        userMenuOpen = false;
        Navigation.NavigateTo("/admin");
    }

    private void NavigateToGroupsLink()
    {
        userMenuOpen = false;
        Navigation.NavigateTo("/grupper");
    }

    private void OpenEdit() { menuOpen = false; editOpen = true; }
    private void OpenCreate() { menuOpen = false; createOpen = true; }
    private void OpenCopy() { menuOpen = false; copyOpen = true; }
    private void OpenDelete() { menuOpen = false; deleteOpen = true; }
    private Task OpenDeleteFromEdit()
    {
        deleteOpen = true;
        return Task.CompletedTask;
    }
    
    private void Save() { menuOpen = false; }

    private Task CloseEdit() { editOpen = false; return Task.CompletedTask; }
    private Task CloseCreate() { createOpen = false; return Task.CompletedTask; }
    private Task CloseCopy() { copyOpen = false; return Task.CompletedTask; }
    private Task CloseDelete() { deleteOpen = false; return Task.CompletedTask; }

    private async Task AfterTemplateSaved()
    {
        await ReloadTemplatesForPlace(true);
        StateHasChanged();
        UI.RaiseChanged();
    }

    private async Task ClearAllCalendarBookings()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Är du säker på att du vill ta bort alla kalenderbokningar? Detta kan inte ångras.");
        if (confirmed)
        {
            await CalendarBookingService.ClearAllCalendarBookingsAsync();
            UI.RaiseChanged(); // Trigger refresh of the calendar view
        }
    }

    private async Task FixAreaLeafRelations()
    {
        if (await JS.InvokeAsync<bool>("confirm", "Fixa AreaLeaf relationer för alla platser? Detta kan ta en stund."))
        {
            var places = await PlaceService.GetPlacesAsync();
            foreach (var place in places)
            {
                await PlaceService.FixMissingAreaLeafRelationsAsync(place.Id);
            }
            await JS.InvokeAsync<string>("alert", "AreaLeaf relationer har fixats för alla platser!");
            UI.RaiseChanged();
        }
    }

    // Calendar navigation methods
    private void NavigateToPreviousWeek()
    {
        UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(-7);
        UI.RaiseChanged();
    }

    private void NavigateToNextWeek()
    {
        UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(7);
        UI.RaiseChanged();
    }

    private void NavigateToPreviousDay()
    {
        UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(-1);
        UI.RaiseChanged();
    }

    private void NavigateToNextDay()
    {
        UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(1);
        UI.RaiseChanged();
    }

    private string GetWeekNumber()
    {
        var culture = new System.Globalization.CultureInfo("sv-SE");
        var calendar = culture.Calendar;
        var weekNumber = calendar.GetWeekOfYear(UI.CurrentWeekStart.ToDateTime(TimeOnly.MinValue), System.Globalization.CalendarWeekRule.FirstDay, DayOfWeek.Monday);
        return weekNumber.ToString();
    }

    private string GetDayText()
    {
        return UI.CurrentWeekStart.ToString("dddd d MMMM yyyy", new System.Globalization.CultureInfo("sv-SE"));
    }
    
    private string GetFormattedDayText()
    {
        return UI.CurrentWeekStart.ToString("dddd, d MMMM yyyy", new System.Globalization.CultureInfo("sv-SE"));
    }

    private void ToggleMoreMenu() => moreMenuOpen = !moreMenuOpen;
    
    private void CloseMoreMenu() => moreMenuOpen = false;
    private void ToggleUserMenu() => userMenuOpen = !userMenuOpen;
    private void CloseUserMenu() => userMenuOpen = false;
    private void PerformLogout()
    {
        userMenuOpen = false;
        // Force full page load to hit the server endpoint
        Navigation.NavigateTo("/auth/logout", forceLoad: true);
    }
    
    private void CloseMenu() => menuOpen = false;
    
    private void OpenBookingModal()
    {
        moreMenuOpen = false;
        UI.ShouldOpenBookingModal = true;
        UI.RaiseChanged();
    }
    
    private void OpenClearWeekConfirm()
    {
        moreMenuOpen = false;
        clearWeekConfirmOpen = true;
        clearWeekConfirmText = "Är du säker på att du vill rensa alla bokningar för denna vecka?";
    }
    
    private void CloseClearWeekConfirm()
    {
        clearWeekConfirmOpen = false;
        clearWeekConfirmText = "";
    }
    
    private async Task ConfirmClearWeek()
    {
        var weekStart = UI.CurrentWeekStart;
        var weekEnd = weekStart.AddDays(6);
        
        var list = await CalendarBookingService.GetBookingsForWeekAsync(weekStart);
        foreach (var b in list)
        {
            await CalendarBookingService.DeleteBookingAsync(b.Id);
        }
        
        clearWeekConfirmOpen = false;
        
        // Force WeekGrid to reload data to show updated calendar immediately
        UI.ForceRefresh = true;
        UI.RaiseChanged();
        
        // Wait a bit to ensure state propagation and database commit
        await Task.Delay(100);
        
        // Trigger another refresh to ensure WeekGrid picks up the changes
        UI.ForceRefresh = true;
        UI.RaiseChanged();
    }
    
    private async Task CopyWeekToClipboard()
    {
        // Only allow copy in calendar view mode
        if (!UI.IsCalendarViewMode)
        {
            moreMenuOpen = false;
            return;
        }
        
        // Copy all calendar bookings for the currently shown week
        var sourceWeekStart = UI.CurrentWeekStart;
        var bookings = await CalendarBookingService.GetBookingsForWeekAsync(sourceWeekStart);
        
        // Store a lightweight copy in UI clipboard (detach EF entities)
        UI.ClipboardWeek = bookings.Select(b => new SchedulerMVP.Data.Entities.CalendarBooking
        {
            AreaId = b.AreaId,
            GroupId = b.GroupId,
            Date = b.Date,
            StartMin = b.StartMin,
            EndMin = b.EndMin,
            Notes = b.Notes,
            ContactName = b.ContactName,
            ContactPhone = b.ContactPhone,
            ContactEmail = b.ContactEmail,
            SourceTemplateId = b.SourceTemplateId
        }).ToList();
        UI.ClipboardWeekStart = sourceWeekStart;
        moreMenuOpen = false;
        
        Console.WriteLine($"[TopBar] CopyWeekToClipboard: Copied {UI.ClipboardWeek.Count} bookings from week starting {sourceWeekStart}");
        
        UI.RaiseChanged();
    }
    
    private async Task PasteWeekFromClipboard()
    {
        if (UI.ClipboardWeek == null || UI.ClipboardWeek.Count == 0)
        {
            moreMenuOpen = false;
            return;
        }
        
        // Only allow paste in calendar view mode
        if (!UI.IsCalendarViewMode)
        {
            moreMenuOpen = false;
            return;
        }
        
        var targetWeekStart = UI.CurrentWeekStart;
        var targetWeekEnd = targetWeekStart.AddDays(6);
        
        // Get existing bookings for the target week to check for duplicates
        var existingBookings = await CalendarBookingService.GetBookingsForWeekAsync(targetWeekStart);
        
        // Create a set of existing booking keys for duplicate checking
        var existingBookingKeys = new HashSet<string>();
        foreach (var eb in existingBookings)
        {
            var key = $"{eb.AreaId}|{eb.GroupId}|{eb.Date:yyyy-MM-dd}|{eb.StartMin}|{eb.EndMin}";
            existingBookingKeys.Add(key);
        }
        
        var createdCount = 0;
        var skippedCount = 0;
        
        foreach (var src in UI.ClipboardWeek)
        {
            // Map source booking's weekday to the target week's same weekday
            var dayIndex0 = (int)src.Date.DayOfWeek; // Sunday=0..Saturday=6
            var mondayBased = (dayIndex0 + 6) % 7;   // Monday=0..Sunday=6
            var targetDate = targetWeekStart.AddDays(mondayBased);
            
            // Skip if target date is outside the target week
            if (targetDate < targetWeekStart || targetDate > targetWeekEnd)
            {
                continue;
            }
            
            // Check for duplicate booking using a string key
            var bookingKey = $"{src.AreaId}|{src.GroupId}|{targetDate:yyyy-MM-dd}|{src.StartMin}|{src.EndMin}";
            if (existingBookingKeys.Contains(bookingKey))
            {
                skippedCount++;
                continue;
            }
            
            var newBooking = new SchedulerMVP.Data.Entities.CalendarBooking
            {
                Id = Guid.NewGuid(),
                AreaId = src.AreaId,
                GroupId = src.GroupId,
                Date = targetDate,
                StartMin = src.StartMin,
                EndMin = src.EndMin,
                Notes = src.Notes,
                ContactName = src.ContactName,
                ContactPhone = src.ContactPhone,
                ContactEmail = src.ContactEmail,
                SourceTemplateId = src.SourceTemplateId,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };
            
            try
            {
                await CalendarBookingService.CreateBookingAsync(newBooking);
                createdCount++;
                
                // Add to existing set to prevent duplicates in the same paste operation
                existingBookingKeys.Add(bookingKey);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[TopBar] Error creating booking during paste: {ex.Message}");
                // Continue with next booking even if one fails
            }
        }
        
        moreMenuOpen = false;
        
        Console.WriteLine($"[TopBar] PasteWeekFromClipboard: Created {createdCount} bookings, skipped {skippedCount} duplicates");
        
        // Force WeekGrid to reload data to show new bookings immediately
        UI.ForceRefresh = true;
        UI.RaiseChanged();
        
        // Wait a bit to ensure state propagation and database commit
        await Task.Delay(100);
        
        // Trigger another refresh to ensure WeekGrid picks up the changes
        UI.ForceRefresh = true;
        UI.RaiseChanged();
    }
    
    private bool CanPasteWeek()
    {
        // Only allow paste in calendar view mode and when clipboard has data
        return UI.IsCalendarViewMode && UI.ClipboardWeek != null && UI.ClipboardWeek.Count > 0;
    }


    private void OpenCopyTemplateModal()
    {
        moreMenuOpen = false;
        UI.ShouldOpenCopyTemplateModal = true;
        UI.RaiseChanged();
    }

    private void OnViewModeChanged(ChangeEventArgs e)
    {
        var isDay = bool.Parse(e.Value?.ToString() ?? "false");
        // Preserve the currently navigated week/day instead of jumping to today's
        var current = UI.CurrentWeekStart;
        UI.IsDayView = isDay;
        if (isDay)
        {
            // Switching Week -> Day: show Monday of the currently displayed week
            var daysSinceMonday = ((int)current.DayOfWeek + 6) % 7;
            UI.CurrentWeekStart = current.AddDays(-daysSinceMonday);
        }
        else
        {
            // Switching Day -> Week: show the week that contains the current day
            var daysSinceMonday = ((int)current.DayOfWeek + 6) % 7;
            UI.CurrentWeekStart = current.AddDays(-daysSinceMonday);
        }
        UI.RaiseChanged();
    }

    private void GoToToday()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        // Find the Monday of the current week for week view, or just use today for day view
        var monday = today.AddDays(-(int)today.DayOfWeek + (int)DayOfWeek.Monday);
        UI.CurrentWeekStart = UI.IsDayView ? today : monday;
        UI.RaiseChanged();
    }
}

@if (clearWeekConfirmOpen)
{
    <div class="modal-container" @onclick="CloseClearWeekConfirm">
        <div class="bm-modal" @onclick:stopPropagation="true">
            <div class="bm-header">
                <h3 class="bm-title">Rensa vecka</h3>
            </div>
            <div class="bm-field">
                <p style="margin:0; color:#64748b; line-height:1.5;">@clearWeekConfirmText</p>
            </div>
            <div class="bm-actions">
                <button type="button" @onclick="CloseClearWeekConfirm" class="btn-outline">Avbryt</button>
                <button type="button" @onclick="ConfirmClearWeek" class="btn-primary" style="background:#dc2626;">Rensa</button>
            </div>
        </div>
    </div>
    <style>
        /* Match CalendarCopyTemplateModal exact structure and styling */
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px 28px 0 28px;border:1px solid #e6e7ea;border-radius:12px;min-width:560px;max-width:720px;width:90vw;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
        .bm-header{position:sticky;top:0;background:#fff;z-index:12;padding-bottom:12px;margin-bottom:0}
        .bm-title{margin:0 0 12px 0;font-size:20px;font-weight:800;letter-spacing:-.02em}
        .bm-field{display:flex;flex-direction:column;gap:8px}
        .bm-label{font-size:14px;font-weight:500;color:#374151}
        .bm-input{width:100%;padding:10px 12px;border-radius:4px;border:1px solid #dcdee2;background-color:#f3f5f7;box-shadow:0 2px 8px 0 rgba(0,0,0,0.02);font-size:12px;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;box-sizing:border-box;min-height:40px}
        .bm-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
        .bm-modal select.bm-input{overflow:visible;text-overflow:clip;white-space:normal}
        .bm-modal select.bm-input option{white-space:normal;word-wrap:break-word;padding:8px}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px;position:sticky;bottom:0;background:#fff;padding-top:12px;padding-bottom:24px;z-index:10}
        .btn-outline,.btn-primary{padding:8px 16px;border-radius:10px;font-size:14px;line-height:20px;min-height:40px;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;transition:background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;cursor:pointer}
        .btn-outline{border:1px solid #d1d5db;background:#fff;color:#0f1720}
        .btn-outline:hover{background:#f1f5f9;box-shadow:0 0 0 2px rgba(99,102,241,0.1)}
        .btn-outline:active{transform:translateY(1px);}
        .btn-primary{border:none;background:#1761a5;color:#fff}
        .btn-primary:hover:not(:disabled){background:#0f4a7a;box-shadow:0 0 0 2px rgba(23,97,165,0.2)}
        .btn-primary:active:not(:disabled){transform:translateY(1px);}
        .btn-primary:disabled{opacity:0.6;cursor:not-allowed;box-shadow:none}
    </style>
}



