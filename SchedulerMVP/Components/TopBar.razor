@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using SchedulerMVP.Data.Entities
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components
@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI
@inject SchedulerMVP.Services.ICalendarBookingService CalendarBookingService
@inject SchedulerMVP.Services.IPlaceService PlaceService
@inject IDbContextFactory<SchedulerMVP.Data.AppDbContext> DbFactory
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject SchedulerMVP.Services.UserContextService UserContextService
@implements IDisposable

@{
    var uri = Navigation.Uri.ToLower();
    var path = new Uri(uri).AbsolutePath.ToLower();
    var isLoginPage = path == "/login" || path.EndsWith("/login");
    var isAdminPage = UI.IsAdminPage || path == "/admin" || path.EndsWith("/admin") || path.Contains("/admin/");
    var isGroupsManagePage = path == "/grupper" || path.EndsWith("/grupper");
    var isWhatsNewPage = path == "/vad-ar-nytt" || path.EndsWith("/vad-ar-nytt");
    var isMyAccountPage = path == "/mitt-konto" || path.EndsWith("/mitt-konto");
    var isHelpPage = path == "/hjalp" || path.EndsWith("/hjalp");
}

@if (!isLoginPage)
{
    <div class="sa-topbar">
        <div class="sa-topbar-row">
            @* Left column: Title and Breadcrumbs *@
            <div class="tb-topbar-left">
                @if (isAdminPage || isGroupsManagePage || isMyAccountPage)
                {
                    <div class="sa-header-content">
                        <button class="btn-back" @onclick="NavigateBack" title="Tillbaka">
                            <span class="material-symbols-outlined">chevron_left</span>
                            Tillbaka
                        </button>
                        <h2 class="sa-page-title">@(isAdminPage ? "Admin" : (isGroupsManagePage ? "Hantera grupper" : "Mitt konto"))</h2>
                    </div>
                }
                else if (isHelpPage)
                {
                    <div class="sa-header-content">
                        <button class="btn-back" @onclick="NavigateBack" title="Tillbaka">
                            <span class="material-symbols-outlined">chevron_left</span>
                            Tillbaka
                        </button>
                    </div>
                }
                else if (isWhatsNewPage)
                {
                    <div class="sa-header-content">
                        <button class="btn-back" @onclick="NavigateBack" title="Tillbaka">
                            <span class="material-symbols-outlined">chevron_left</span>
                            Tillbaka
                        </button>
                    </div>
                }
                else
                {
                    <div class="sa-header-content">
                        <h2 class="sa-page-title">@UI.PageTitle</h2>
                        @if (breadcrumbItems.Count > 0)
                        {
                            <div class="sa-breadcrumb">
                                @for (int i = 0; i < breadcrumbItems.Count; i++)
                                {
                                    var item = breadcrumbItems[i];
                                    var isLast = i == breadcrumbItems.Count - 1;
                                    var isRoot = i == 0;
                                    
                                    if (isRoot)
                                    {
                                        <span class="sa-breadcrumb-root">@item.Name</span>
                                    }
                                    else
                                    {
                                        <span class="sa-breadcrumb-item @(isLast ? "sa-breadcrumb-current" : "")" @onclick="@(() => NavigateBreadcrumb(item))">@item.Name</span>
                                    }
                                    
                                    @if (!isLast) { <span class="sa-breadcrumb-separator">/</span> }
                                }
                            </div>
                        }
                    </div>
                }
            </div>
            
            @* Right column: Actions *@
            <div class="tb-topbar-right">
                @if (!isAdminPage && !isGroupsManagePage && !isWhatsNewPage && !isMyAccountPage && !isHelpPage)
                {
                    <div class="calendar-actions">
                        @* Main View Switcher *@
                        <div class="view-toggle">
                            <button class="view-toggle-btn @(UI.IsCalendarViewMode ? "" : "active")" @onclick="() => SetCalendarMode(false)">Veckoschema</button>
                            <button class="view-toggle-btn @(UI.IsCalendarViewMode ? "active" : "")" @onclick="() => SetCalendarMode(true)">Kalender</button>
                        </div>
                    </div>
                }

                @* User menu *@
                <div style="position: relative; margin-left: 12px;">
                    <button class="btn-nav" @onclick="ToggleUserMenu" title="Meny" aria-label="Meny">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <rect x="3" y="6" width="18" height="2" rx="1" fill="#000"/>
                            <rect x="3" y="11" width="18" height="2" rx="1" fill="#000"/>
                            <rect x="3" y="16" width="18" height="2" rx="1" fill="#000"/>
                        </svg>
                    </button>
                    @if (userMenuOpen)
                    {
                        <div class="menu-overlay" @onclick="CloseUserMenu"></div>
                        <div class="tb-menu">
                            <div class="tb-item user-email">@currentUserEmail</div>
                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                            @if (isCurrentUserAdmin == true)
                            {
                                <a href="/admin" class="tb-item" style="text-decoration:none;">Admin</a>
                            }
                            <a href="/grupper" class="tb-item" style="text-decoration:none;">Hantera grupper</a>
                            <a href="/mitt-konto" class="tb-item" style="text-decoration:none;">Mitt konto</a>
                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                            <a href="/vad-ar-nytt" class="tb-item" style="text-decoration:none;">Vad är nytt?</a>
                            <a href="/hjalp" class="tb-item" style="text-decoration:none;">Hjälp</a>
                            <div style="border-top: 1px solid #e4e4e4; margin: 8px 0;"></div>
                            <button class="tb-item danger" @onclick="PerformLogout">Logga ut</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    .sa-topbar { padding: 16px 24px; background: #fff; border-bottom: 1px solid #e5e7eb; z-index: 100; }
    .sa-topbar-row { display: flex; align-items: center; justify-content: space-between; }
    .tb-topbar-left, .tb-topbar-right { display: flex; align-items: center; gap: 12px; }
    .sa-header-content { display: flex; align-items: center; gap: 16px; }
    .sa-page-title { margin: 0; font-size: 24px; font-weight: 600; color: #333; }
    .sa-breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 14px; color: #6b7280; }
    .sa-breadcrumb-item { cursor: pointer; }
    .sa-breadcrumb-item:hover { color: #1f2937; text-decoration: underline; }
    .sa-breadcrumb-current { color: #374151; font-weight: 600; cursor: default; }
    .sa-breadcrumb-root { color: #94a3b8; cursor: default; }
    .calendar-actions { display: flex; align-items: center; gap: 16px; margin-left: auto; }
    .view-toggle { display: flex; background: #f1f5f9; border-radius: 8px; padding: 2px; }
    .view-toggle-btn { border: none; background: transparent; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; color: #64748b; cursor: pointer; transition: all 0.2s; height: 30px; display: flex; align-items: center; }
    .view-toggle-btn.active { background: #fff; color: #0F4A7A !important; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .nav-group { display: flex; align-items: center; gap: 4px; }
    .nav-text { font-weight: 500; margin: 0 8px; font-size: 14px; white-space: nowrap; }
    .btn { height: 34px; padding: 0 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; }
    .btn-nav {
        display: inline-flex;
        padding: 8px;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 6px;
        background: #eeeeee;
        color: #000;
        cursor: pointer;
        transition: all 0.2s;
        width: 34px;
        height: 34px;
        box-sizing: border-box;
    }
    .btn-nav:hover { background: #e4e4e4; }
    .btn-nav:focus { outline: none; background: #eeeeee; border: 1px solid #cfcfcf; }
    .btn-nav svg {
        width: 18px !important;
        height: 18px !important;
        flex-shrink: 0;
    }
    .btn-back {
        display: inline-flex;
        padding: 8px 12px;
        align-items: center;
        gap: 4px;
        border: none;
        background: transparent;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        margin-right: 16px;
    }
    .btn-back:hover { color: #1f2937; }
    .btn-back:focus { outline: none; }
    .btn-back .material-symbols-outlined { font-size: 20px; vertical-align: middle; }

    .tb-menu { position: absolute; top: 40px; right: 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 8px; min-width: 200px; z-index: 1000; }
    .tb-item { display: flex; align-items: center; width: 100%; padding: 8px 12px; border-radius: 6px; border: none; background: transparent; font-size: 13px; cursor: pointer; text-align: left; }
    .tb-item:hover { background: #f1f5f9; }
    .tb-item.danger { color: #ef4444; }
    .menu-overlay { position: fixed; inset: 0; z-index: 999; }
    .user-email { font-size: 12px; color: #64748b; cursor: default; }
</style>

@code {
    private List<ScheduleTemplate> templates = new();
    private bool userMenuOpen;
    private string? currentUserEmail;
    private bool? isCurrentUserAdmin; // Nullable to track if loaded
    private List<BreadcrumbItem> breadcrumbItems = new();

    protected override void OnInitialized() {
        UI.OnChanged += HandleUIStateChanged;
        Navigation.LocationChanged += HandleLocationChanged;
        try {
            var user = HttpContextAccessor?.HttpContext?.User;
            currentUserEmail = user?.FindFirstValue(ClaimTypes.Email) ?? user?.Identity?.Name;
            // Don't check admin status here - do it async in OnInitializedAsync to avoid blocking
        } catch {}
    }

    public void Dispose() {
        UI.OnChanged -= HandleUIStateChanged;
        Navigation.LocationChanged -= HandleLocationChanged;
    }

    private void HandleUIStateChanged() {
        InvokeAsync(async () => {
            await LoadBreadcrumbsAsync();
            StateHasChanged();
        });
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e) {
        CloseUserMenu(); // Close menu when navigating to a new page
        OnLocationChanged();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync() {
        await LoadBreadcrumbsAsync();
        // Load admin status asynchronously to avoid blocking
        // Only load if not already loaded to avoid multiple calls
        if (!isCurrentUserAdmin.HasValue)
        {
            try {
                if (string.IsNullOrEmpty(currentUserEmail))
                {
                    var user = HttpContextAccessor?.HttpContext?.User;
                    currentUserEmail = user?.FindFirstValue(ClaimTypes.Email) ?? user?.Identity?.Name;
                }
                // Use UserContext service for reliable admin check - it has built-in caching
                isCurrentUserAdmin = await UserContextService.IsAdminAsync();
                StateHasChanged();
            } catch (Exception ex) {
                Console.WriteLine($"[TopBar] Error loading admin status: {ex.Message}");
                isCurrentUserAdmin = false;
            }
        }
    }

    private void SetCalendarMode(bool isCalendar) {
        UI.IsCalendarViewMode = isCalendar;
        UI.IsDayView = false; UI.IsWeekListView = false; UI.IsResourceView = false;
        UI.PageTitle = isCalendar ? "Kalender" : "Veckoschema";
        UI.RaiseChanged();
    }

    private async Task LoadBreadcrumbsAsync() {
        var newItems = new List<BreadcrumbItem>();
        await using var db = await DbFactory.CreateDbContextAsync();

        if (UI.SelectedAreaId.HasValue) {
            var areaId = UI.SelectedAreaId.Value;
            var areaChain = new List<BreadcrumbItem>();
            Guid? placeId = null;

            // Traverse up using ParentAreaId - most reliable way
            while (areaId != Guid.Empty) {
                var area = await db.Areas.AsNoTracking().FirstOrDefaultAsync(a => a.Id == areaId);
                if (area == null) break;
                
                areaChain.Insert(0, new BreadcrumbItem { Name = area.Name, AreaId = area.Id });
                placeId = area.PlaceId;
                
                if (area.ParentAreaId.HasValue && area.ParentAreaId.Value != Guid.Empty) {
                    areaId = area.ParentAreaId.Value;
                } else {
                    areaId = Guid.Empty;
                }
            }

            if (placeId.HasValue) {
                var place = await db.Places.AsNoTracking().FirstOrDefaultAsync(p => p.Id == placeId.Value);
                if (place != null) {
                    newItems.Add(new BreadcrumbItem { Name = place.Name, PlaceId = place.Id });
                }
            }
            newItems.AddRange(areaChain);
        } else if (UI.SelectedPlaceId.HasValue) {
            var place = await db.Places.AsNoTracking().FirstOrDefaultAsync(p => p.Id == UI.SelectedPlaceId.Value);
            if (place != null) {
                newItems.Add(new BreadcrumbItem { Name = place.Name, PlaceId = place.Id });
            }
        }
        
        breadcrumbItems = newItems;
    }

    private class BreadcrumbItem { public string Name = ""; public Guid? PlaceId, AreaId; }

    private void NavigateBreadcrumb(BreadcrumbItem item) {
        if (item.PlaceId.HasValue) { UI.SelectedPlaceId = item.PlaceId.Value; UI.SelectedAreaId = null; }
        else if (item.AreaId.HasValue) UI.SelectedAreaId = item.AreaId.Value;
        UI.RaiseChanged();
    }

    private void OnLocationChanged() {
        var path = new Uri(Navigation.Uri).AbsolutePath.ToLower();
        UI.IsAdminPage = path.Contains("/admin");
        UI.PageTitle = UI.IsAdminPage ? "Admin" : (path.Contains("/grupper") ? "Hantera grupper" : (UI.IsCalendarViewMode ? "Kalender" : "Veckoschema"));
    }

    private void NavigateBack() => Navigation.NavigateTo("/");
    private void PerformLogout() => Navigation.NavigateTo("/auth/logout", true);
    private void ToggleUserMenu() 
    { 
        userMenuOpen = !userMenuOpen;
        // Ensure admin status is loaded when menu opens (only if not already loaded)
        if (userMenuOpen && !isCurrentUserAdmin.HasValue)
        {
            _ = InvokeAsync(async () =>
            {
                try
                {
                    isCurrentUserAdmin = await UserContextService.IsAdminAsync();
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[TopBar] Error loading admin status in menu: {ex.Message}");
                    isCurrentUserAdmin = false;
                    StateHasChanged();
                }
            });
        }
    }
    private void CloseUserMenu() => userMenuOpen = false;
    private void NavigateToPreviousWeek() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(-7); UI.RaiseChanged(); }
    private void NavigateToNextWeek() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(7); UI.RaiseChanged(); }
    private void NavigateToPreviousDay() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(-1); UI.RaiseChanged(); }
    private void NavigateToNextDay() { UI.CurrentWeekStart = UI.CurrentWeekStart.AddDays(1); UI.RaiseChanged(); }
    private void NavigateToPreviousDayWeekSchedule() { SetCurrentDayForSchedule(GetCurrentDayOfWeekForSchedule() == 1 ? 7 : GetCurrentDayOfWeekForSchedule() - 1); }
    private void NavigateToNextDayWeekSchedule() { SetCurrentDayForSchedule(GetCurrentDayOfWeekForSchedule() == 7 ? 1 : GetCurrentDayOfWeekForSchedule() + 1); }
    private int GetCurrentDayOfWeekForSchedule() { var d = (int)UI.CurrentWeekStart.DayOfWeek; return d == 0 ? 7 : d; }
    private void SetCurrentDayForSchedule(int d) { 
        var start = UI.CurrentWeekStart; var diff = (int)start.DayOfWeek; if (diff == 0) diff = 7;
        UI.CurrentWeekStart = start.AddDays(-(diff - 1)).AddDays(d - 1); UI.RaiseChanged();
    }
    private string GetFormattedDayNameWeekSchedule() => GetCurrentDayOfWeekForSchedule() switch { 1=>"Måndag", 2=>"Tisdag", 3=>"Onsdag", 4=>"Torsdag", 5=>"Fredag", 6=>"Lördag", 7=>"Söndag", _=>"" };
    private string GetWeekNumber() => System.Globalization.ISOWeek.GetWeekOfYear(UI.CurrentWeekStart.ToDateTime(TimeOnly.MinValue)).ToString();
    private string GetFormattedDayText() => UI.CurrentWeekStart.ToString("dddd, d MMMM yyyy", new System.Globalization.CultureInfo("sv-SE"));
    private void GoToToday() { UI.CurrentWeekStart = DateOnly.FromDateTime(DateTime.Today); UI.RaiseChanged(); }
}
