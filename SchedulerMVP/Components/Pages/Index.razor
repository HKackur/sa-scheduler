@implements IDisposable
@page "/"
@using SchedulerMVP.Data.Entities
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager Navigation
@inject SchedulerMVP.Services.UIState UI
@inject IDbContextFactory<SchedulerMVP.Data.AppDbContext> DbFactory
@inject SchedulerMVP.Services.IPlaceService PlaceService
@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService

<PageTitle>@UI.PageTitle</PageTitle>

<div class="sa-app">
    <div class="sa-shell-new">
        <main class="sa-panel @((UI.IsResourceView || UI.IsWeekListView) ? "sa-center-full" : "sa-center-new")">
            <ViewToggleBar />
            @if (UI.IsResourceView)
            {
                <ResourceView OnOpenModal="OpenBookingModalFromResource" OnOpenTemplateEdit="OpenTemplateEditModal" />
            }
            else
            {
                <WeekGrid OnOpenModal="OpenBookingModal" OnOpenCalendarBookingEdit="OpenCalendarBookingEditModal" OnOpenTemplateEdit="OpenTemplateEditModal" />
            }
        </main>
        @if (!UI.IsResourceView && !UI.IsWeekListView)
        {
            <aside class="sa-panel sa-right-new">
                <CombinedSidebar />
            </aside>
        }
    </div>
</div>

<BookingModal 
    IsOpen="@UI.ShouldOpenBookingModal"
    SelectedArea="@selectedArea"
    SelectedPlace="@selectedPlace"
    PrefilledDay="@prefilledDay"
    PrefilledStartTime="@prefilledStartTime"
    PrefilledEndTime="@prefilledEndTime"
    PrefilledGroupId="@GetPrefilledGroupId()"
    OnClose="CloseBookingModal"
    OnSave="OnBookingSaved" />

<CalendarCopyTemplateModal 
    IsOpen="@UI.ShouldOpenCopyTemplateModal"
    OnClose="CloseCopyTemplateModal"
    OnCopied="RefreshAfterTemplateCopy" />

<CalendarBookingEditModal 
    IsOpen="@calendarEditOpen"
    Booking="@calendarEditBooking"
    OnClose="CloseCalendarEditModal"
    OnSave="RefreshAfterCalendarEdit" />

<BookingTemplateEditModal 
    IsOpen="@templateEditOpen"
    TemplateId="@templateEditId"
    OnClose="CloseTemplateEditModal"
    OnChanged="RefreshAfterTemplateEdit" />

<ToastUndo />

@code {
    private Area? selectedArea;
    private Place? selectedPlace;
    private int? prefilledDay;
    private string? prefilledStartTime;
    private string? prefilledEndTime;
    
    private bool calendarEditOpen = false;
    private CalendarBooking? calendarEditBooking = null;
    
    private bool templateEditOpen = false;
    private Guid? templateEditId = null;
    
    // PERF: Preloading state
    private bool isInitialLoading = true;
    private string loadingMessage = "L채ser in era bokningar... Snart redo";
    
    protected override void OnInitialized()
    {
        UI.OnChanged += HandleUIStateChanged;
        
        // ...
    }

    private void HandleUIStateChanged()
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        UI.OnChanged -= HandleUIStateChanged;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ...
            
            // Watch for modal open requests
            UI.OnChanged += HandleModalOpenRequests;
        }
    }

    private async void HandleModalOpenRequests()
    {
        // Don't open booking modal if template edit modal or calendar edit modal is open
        if (UI.ShouldOpenBookingModal && !templateEditOpen && !calendarEditOpen)
        {
            // Default values when opening from UI state
            await OpenBookingModal((1, "08:00"));
        }
    }
    
    private bool isOpeningBookingModal = false; // Prevent double-clicks
    
    private async Task OpenBookingModalFromResource((int dayOfWeek, string startTime, Guid areaId) data)
    {
        // Prevent double-clicks
        if (isOpeningBookingModal) return;
        isOpeningBookingModal = true;
        
        try
        {
            // Load area and place data FIRST (synchronously) before opening modal
            await using var db = await DbFactory.CreateDbContextAsync();
            var area = await db.Areas.Include(a => a.Place).FirstOrDefaultAsync(a => a.Id == data.areaId);
            
            if (area?.Place == null)
            {
                Console.WriteLine($"Area or Place not found for areaId: {data.areaId}");
                isOpeningBookingModal = false;
                return;
            }
            
            // Set area and place BEFORE opening modal
            selectedArea = area;
            selectedPlace = area.Place;
            
            // Set prefilled values
            prefilledDay = data.dayOfWeek;
            prefilledStartTime = data.startTime;
            
            // Calculate end time based on place's default duration
            if (selectedPlace.DefaultDurationMin > 0)
            {
                var startMinutes = TimeOnly.Parse(data.startTime).ToTimeSpan().TotalMinutes;
                var endMinutes = startMinutes + selectedPlace.DefaultDurationMin;
                var endTime = TimeOnly.FromTimeSpan(TimeSpan.FromMinutes(endMinutes));
                prefilledEndTime = endTime.ToString("HH:mm");
            }
            else
            {
                // Default to 1 hour if no default duration
                var startTime = TimeOnly.Parse(data.startTime);
                var endTime = startTime.AddHours(1);
                prefilledEndTime = endTime.ToString("HH:mm");
            }
            
            // Set selected area ID
            UI.SelectedAreaId = data.areaId;
            
            // Now open modal with all data ready
            UI.ShouldOpenBookingModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening booking modal from resource: {ex.Message}");
        }
        finally
        {
            isOpeningBookingModal = false;
        }
    }
    
    private async Task OpenBookingModal((int dayOfWeek, string startTime) data)
    {
        // Prevent double-clicks
        if (isOpeningBookingModal) return;
        isOpeningBookingModal = true;
        
        try
        {
            // Set prefilled values immediately (no DB query needed)
            prefilledDay = data.dayOfWeek;
            prefilledStartTime = data.startTime;
            
            // Open modal IMMEDIATELY - don't wait for database
            UI.ShouldOpenBookingModal = true;
            StateHasChanged();
            
            // Now load data asynchronously in background
            if (UI.SelectedAreaId.HasValue)
            {
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await using var db = await DbFactory.CreateDbContextAsync();
                        var area = await db.Areas.Include(a => a.Place).FirstOrDefaultAsync(a => a.Id == UI.SelectedAreaId.Value);
                        
                        if (area?.Place != null)
                        {
                            selectedArea = area;
                            selectedPlace = area.Place;
                            
                            // Calculate end time based on place's default duration
                            if (selectedPlace.DefaultDurationMin > 0)
                            {
                                var startMinutes = TimeOnly.Parse(data.startTime).ToTimeSpan().TotalMinutes;
                                var endMinutes = startMinutes + selectedPlace.DefaultDurationMin;
                                var endTime = TimeOnly.FromTimeSpan(TimeSpan.FromMinutes(endMinutes));
                                prefilledEndTime = endTime.ToString("HH:mm");
                            }
                            
                            await InvokeAsync(StateHasChanged);
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error loading area data: {ex.Message}");
                    }
                    finally
                    {
                        isOpeningBookingModal = false;
                    }
                });
            }
            else
            {
                // Group filter or no specific area selected: use basic defaults
                selectedArea = null;
                selectedPlace = null;
                
                // Default duration 60 minutes when we don't have a place to derive from
                var startMinutes = TimeOnly.Parse(data.startTime).ToTimeSpan().TotalMinutes;
                var endMinutes = startMinutes + 60;
                var endTime = TimeOnly.FromTimeSpan(TimeSpan.FromMinutes(endMinutes));
                prefilledEndTime = endTime.ToString("HH:mm");
                
                isOpeningBookingModal = false;
            }
        }
        catch
        {
            isOpeningBookingModal = false;
        }
    }
    
    private void CloseBookingModal()
    {
        UI.ShouldOpenBookingModal = false;
        prefilledDay = null;
        prefilledStartTime = null;
        prefilledEndTime = null;
        StateHasChanged();
    }
    
    private Guid? GetPrefilledGroupId()
    {
        return UI.IsGroupFilterActive ? UI.FilteredGroupId : null;
    }
    
    private async Task OnBookingSaved()
    {
        UI.ShouldOpenBookingModal = false;
        prefilledDay = null;
        prefilledStartTime = null;
        prefilledEndTime = null;
        
        // Refresh UI immediately - modal is already closed
        StateHasChanged();
        
        // Trigger WeekGrid refresh after state update
        await Task.Delay(10); // Minimal delay for state propagation
        UI.RaiseChanged();
    }
    
    private void CloseCopyTemplateModal()
    {
        UI.ShouldOpenCopyTemplateModal = false;
        StateHasChanged();
    }
    
    private async Task RefreshAfterTemplateCopy()
    {
        Console.WriteLine("[Index] RefreshAfterTemplateCopy called");
        
        // Ensure modal is closed
        UI.ShouldOpenCopyTemplateModal = false;
        
        // Force WeekGrid to reload data to show new bookings immediately
        UI.ForceRefresh = true;
        
        // Trigger state change
        StateHasChanged();
        UI.RaiseChanged();
        
        // Wait a bit longer to ensure state propagation and database commit
        await Task.Delay(200);
        
        // Trigger another refresh to ensure WeekGrid picks up the changes
        UI.ForceRefresh = true;
        UI.RaiseChanged();
        StateHasChanged();
        
        Console.WriteLine("[Index] RefreshAfterTemplateCopy completed");
    }
    
    private bool isOpeningCalendarEdit = false; // Prevent double-clicks
    
    private async Task OpenCalendarBookingEditModal(Guid bookingId)
    {
        // Prevent double-clicks
        if (isOpeningCalendarEdit) return;
        isOpeningCalendarEdit = true;
        
        try
        {
            // Open modal IMMEDIATELY with a placeholder
            calendarEditBooking = null; // Will be loaded async
            calendarEditOpen = true;
            StateHasChanged();
            
            // Load data asynchronously in background
            _ = Task.Run(async () =>
            {
                try
                {
                    await using var db = await DbFactory.CreateDbContextAsync();
                    var booking = await db.CalendarBookings
                        .Include(cb => cb.Area)
                            .ThenInclude(a => a.Place)
                        .Include(cb => cb.Group)
                        .FirstOrDefaultAsync(cb => cb.Id == bookingId);
                    
                    if (booking != null)
                    {
                        calendarEditBooking = booking;
                        await InvokeAsync(StateHasChanged);
                    }
                    else
                    {
                        // Booking not found, close modal
                        calendarEditOpen = false;
                        await InvokeAsync(StateHasChanged);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading calendar booking: {ex.Message}");
                    calendarEditOpen = false;
                    await InvokeAsync(StateHasChanged);
                }
                finally
                {
                    isOpeningCalendarEdit = false;
                }
            });
        }
        catch
        {
            isOpeningCalendarEdit = false;
        }
    }
    
    private void CloseCalendarEditModal()
    {
        calendarEditOpen = false;
        calendarEditBooking = null;
        StateHasChanged();
    }
    
    private async Task RefreshAfterCalendarEdit()
    {
        calendarEditOpen = false;
        calendarEditBooking = null;
        
        // Notify WeekGrid to refresh after edit
        UI.ForceRefresh = true;
        UI.RaiseChanged();
        
        // Give a small delay to ensure the UI state change is processed
        await Task.Delay(50);
        StateHasChanged();
    }
    
    private async Task OpenTemplateEditModal(Guid templateId)
    {
        try
        {
            // Ensure booking modal is closed when opening template edit modal
            UI.ShouldOpenBookingModal = false;
            templateEditId = templateId;
            templateEditOpen = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening template edit modal: {ex.Message}");
        }
    }
    
    private void CloseTemplateEditModal()
    {
        // Ensure booking modal doesn't open when closing template edit modal
        UI.ShouldOpenBookingModal = false;
        templateEditOpen = false;
        templateEditId = null;
        StateHasChanged();
    }
    
    private async Task RefreshAfterTemplateEdit()
    {
        // CRITICAL: Ensure booking modal doesn't open when closing template edit modal
        // Set this BEFORE closing the modal and raising changed events
        UI.ShouldOpenBookingModal = false;
        
        templateEditOpen = false;
        templateEditId = null;
        
        // Force a state change first to ensure ShouldOpenBookingModal is cleared
        StateHasChanged();
        await Task.Delay(10); // Small delay to ensure state is updated
        
        // Now notify WeekGrid to refresh after template edit
        UI.ForceRefresh = true;
        UI.RaiseChanged();
        
        // Give a small delay to ensure the UI state change is processed
        await Task.Delay(50);
        StateHasChanged();
    }
    
    private async Task PreloadDataAsync()
    {
        try
        {
            loadingMessage = "L채ser in platser...";
            await InvokeAsync(StateHasChanged);
            
            // Preload all places and areas
            var places = await PlaceService.GetPlacesAsync();
            foreach (var place in places.Take(3)) // Preload first 3 places' areas
            {
                await PlaceService.GetAreasForPlaceAsync(place.Id);
            }
            
            loadingMessage = "L채ser in veckomallar...";
            await InvokeAsync(StateHasChanged);
            
            // Preload templates
            await TemplateService.GetTemplatesAsync();
            
            loadingMessage = "N채stan klart...";
            await InvokeAsync(StateHasChanged);
            
            // Small delay for smooth transition
            await Task.Delay(300);
            
            // Hide loading screen
            isInitialLoading = false;
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // On error, just hide loading screen
            isInitialLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}


