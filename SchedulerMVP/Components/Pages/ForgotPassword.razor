@page "/forgot-password"
@layout Layout.LoginLayout
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using SchedulerMVP.Data.Entities
@using SchedulerMVP.Services
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject IEmailService EmailService
@inject IJSRuntime JS

<PageTitle>Glömt lösenord</PageTitle>

<div class="login-page">
    <header class="login-logo" aria-label="Sportadmin Labs">
        <img class="login-logo-primary" src="Sportadmin Labs Logo.png" alt="Sportadmin Labs" />
    </header>

    <section class="login-content" aria-labelledby="forgot-heading">
        @if (isSuccess)
        {
            <div class="login-text">
                <h1 id="forgot-heading">E-post skickad</h1>
                <p>Om en användare med den e-postadressen finns, har vi skickat en länk för att återställa ditt lösenord.</p>
                <p style="font-size: 14px; color: #666; margin-top: 16px;">Kontrollera din inkorg och följ instruktionerna i e-postmeddelandet.</p>
            </div>
            <div class="login-form">
                <button type="button" class="login-button" @onclick="GoToLogin">
                    Tillbaka till inloggning
                </button>
            </div>
        }
        else
        {
            <div class="login-text">
                <h1 id="forgot-heading">Glömt ditt lösenord?</h1>
                <p>Ange din e-postadress så skickar vi en länk för att återställa ditt lösenord.</p>
            </div>

            <div class="login-form">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message" role="alert">@errorMessage</div>
                }

                <form @onsubmit:preventDefault="true">
                    <div class="form-group">
                        <label for="email">Epost</label>
                        <input id="email" name="email" class="form-control" type="email" @bind="email" placeholder="Ange din e-postadress" required />
                    </div>

                    <button type="button" class="login-button" @onclick="SendResetLink" disabled="@(string.IsNullOrWhiteSpace(email) || isProcessing)">
                        @if (isProcessing)
                        {
                            <span>Skickar...</span>
                        }
                        else
                        {
                            <span>Skicka återställningslänk</span>
                        }
                    </button>
                </form>
                
                <div class="forgot-password-link">
                    <a href="/login">Tillbaka till inloggning</a>
                </div>
            </div>
        }
    </section>
</div>

@code {
    private string email = string.Empty;
    private string? errorMessage;
    private bool isProcessing = false;
    private bool isSuccess = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Force hide TopBar with JavaScript after render
            await JS.InvokeVoidAsync("eval", @"
                (function() {
                    const hideTopBar = () => {
                        const topBar = document.querySelector('.sa-topbar');
                        if (topBar) {
                            topBar.style.cssText = 'display:none!important;visibility:hidden!important;height:0!important;overflow:hidden!important;position:absolute!important;left:-99999px!important;opacity:0!important;';
                        }
                    };
                    hideTopBar();
                    setTimeout(hideTopBar, 100);
                    setTimeout(hideTopBar, 500);
                })();
            ");
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task SendResetLink()
    {
        if (string.IsNullOrWhiteSpace(email) || isProcessing)
            return;

        isProcessing = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Call backend endpoint to request password reset
            var response = await new HttpClient().PostAsync(
                $"{Navigation.BaseUri.TrimEnd('/')}/auth/forgot-password",
                new FormUrlEncodedContent(new[] { new KeyValuePair<string, string>("email", email) })
            );

            if (response.IsSuccessStatusCode)
            {
                isSuccess = true;
            }
            else
            {
                // Always show success message for security (don't reveal if user exists)
                isSuccess = true;
            }
        }
        catch (Exception ex)
        {
            // Even on error, show success for security
            isSuccess = true;
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}

