@page "/admin"
@using Microsoft.AspNetCore.Identity
@using SchedulerMVP.Data.Entities
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Nav
@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI

<div class="sa-panel" style="padding:16px; overflow-y: auto; overflow-x: hidden; padding-bottom: 64px;">
    @if (isLoading)
    {
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 12px;">
            <div style="width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: admin-spin 0.8s linear infinite;"></div>
            <div style="font-size: 14px; color: #6b7280;">Läser in användare...</div>
        </div>
    }

    <!-- Create User Button -->
    <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
        <button class="tb-btn" @onclick="OpenCreateUserModal">
            <span class="material-symbols-outlined" style="font-size:18px;">add</span>
            Skapa användare
        </button>
    </div>

    <!-- Users table -->
    <h3 class="groups-table-title" style="margin-bottom:12px;">Användare</h3>
    <div class="groups-table-container">
        <table class="groups-table">
            <thead>
                <tr>
                    <th>E-post</th>
                    <th>Senast inloggad</th>
                    <th>Admin</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in users)
                {
                    var isAdmin = adminIds.Contains(u.Id);
                    <tr>
                        <td>@u.Email</td>
                        <td>@FormatLastLogin(u.LastLoginAt)</td>
                        <td>
                            @if (isAdmin)
                            {
                                <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#d1fae5; color:#065f46; border:1px solid #6ee7b7;">Ja</span>
                            }
                            else
                            {
                                <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#f3f4f6; color:#6b7280;">Nej</span>
                            }
                        </td>
                        <td style="position:relative;">
                            <button class="action-menu-trigger" @onclick="() => ToggleActionMenu(u.Id)" @onclick:stopPropagation="true">
                                <span class="material-symbols-outlined">more_vert</span>
                            </button>
                            @if (actionMenuOpenForUserId == u.Id)
                            {
                                <div class="action-menu" @onclick:stopPropagation="true">
                                    <button class="action-menu-item" @onclick="() => Impersonate(u.Id)" disabled="@(isProcessing.Contains(u.Id))">Logga in som</button>
                                    <button class="action-menu-item" @onclick="() => ToggleAdmin(u.Id)" disabled="@(isProcessing.Contains(u.Id))">
                                        @(isProcessing.Contains(u.Id) && processingAction.ContainsKey(u.Id) && processingAction[u.Id] == "admin" ? "Uppdaterar..." : (isAdmin ? "Ta bort admin" : "Gör admin"))
                                    </button>
                                    <button class="action-menu-item" @onclick="() => ResetPassword(u.Id)" disabled="@(isProcessing.Contains(u.Id))">Nytt lösenord</button>
                                    <button class="action-menu-item" style="color:#dc2626;" @onclick="() => DeleteUser(u.Id)" disabled="@(isProcessing.Contains(u.Id))">Radera</button>
                                </div>
                                <div class="menu-overlay" @onclick="CloseActionMenu"></div>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<CreateUserModal IsOpen="@createUserModalOpen" OnClose="CloseCreateUserModal" OnCreated="AfterUserCreated" />

<style>
    @@keyframes admin-spin {
        to { transform: rotate(360deg); }
    }

    .groups-table-container {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: visible !important;
        min-height: fit-content;
    }

    .groups-table-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
        padding: 0;
    }

    .groups-table {
        width: 100%;
        border-collapse: collapse;
        display: table;
    }

    .groups-table thead {
        background: #F9FAFB;
    }

    .groups-table th {
        padding: 12px 20px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #6B7280;
        border-bottom: 1px solid #e5e7eb;
    }

    .groups-table tbody tr {
        border-bottom: 1px solid #f3f4f6;
    }

    .groups-table tbody tr:last-child {
        border-bottom: none;
    }

    .groups-table td {
        padding: 12px 20px;
        font-size: 14px;
        color: #111827;
    }

    .action-menu-trigger {
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6B7280;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .action-menu-trigger:hover {
        background: #f3f4f6;
    }

    .action-menu-trigger .material-symbols-outlined {
        font-size: 20px;
    }

    .action-menu {
        position: absolute;
        top: 32px;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        padding: 8px;
        min-width: 160px;
        z-index: 1000;
    }

    .action-menu-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        background: transparent;
        font-size: 13px;
        cursor: pointer;
        text-align: left;
        color: #111827;
        transition: background 0.2s;
    }

    .action-menu-item:hover:not(:disabled) {
        background: #f1f5f9;
    }

    .action-menu-item:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .menu-overlay {
        position: fixed;
        inset: 0;
        z-index: 999;
    }
</style>

@code {
    private List<ApplicationUser> users = new();
    private HashSet<string> adminIds = new();
    private string? errorMessage;
    private bool isLoading = true;
    private bool createUserModalOpen = false;
    private HashSet<string> isProcessing = new();
    private Dictionary<string, string> processingAction = new();
    private string? actionMenuOpenForUserId;

    protected override async Task OnInitializedAsync()
    {
        UI.IsAdminPage = true;
        UI.PageTitle = "Admin";
        await LoadAsync();
    }

    public void Dispose()
    {
        UI.IsAdminPage = false;
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            await Task.Delay(100);
            
            users = UserManager.Users.OrderBy(u => u.Email).ToList();
            
            var adminRole = await RoleManager.FindByNameAsync("Admin");
            if (adminRole != null)
            {
                var adminCheckTasks = users.Select(async u => new { Id = u.Id, IsAdmin = await UserManager.IsInRoleAsync(u, "Admin") });
                var results = await Task.WhenAll(adminCheckTasks);
                adminIds = new HashSet<string>(results.Where(r => r.IsAdmin).Select(r => r.Id));
            }
            else
            {
                adminIds = new HashSet<string>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid laddning: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private static string FormatLastLogin(DateTimeOffset? ts) => ts.HasValue ? ts.Value.LocalDateTime.ToString("yyyy-MM-dd HH:mm") : "—";

    private void OpenCreateUserModal()
    {
        createUserModalOpen = true;
        StateHasChanged();
    }
    
    private void CloseCreateUserModal()
    {
        createUserModalOpen = false;
        StateHasChanged();
    }
    
    private async Task AfterUserCreated()
    {
        await LoadAsync();
        CloseCreateUserModal();
    }

    private void ToggleActionMenu(string userId)
    {
        if (actionMenuOpenForUserId == userId)
        {
            actionMenuOpenForUserId = null;
        }
        else
        {
            actionMenuOpenForUserId = userId;
        }
        StateHasChanged();
    }

    private void CloseActionMenu()
    {
        actionMenuOpenForUserId = null;
        StateHasChanged();
    }

    private async Task ToggleAdmin(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "admin";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            
            var wasAdmin = await UserManager.IsInRoleAsync(u, "Admin");
            if (wasAdmin)
            {
                await UserManager.RemoveFromRoleAsync(u, "Admin");
                adminIds.Remove(userId);
            }
            else
            {
                await UserManager.AddToRoleAsync(u, "Admin");
                adminIds.Add(userId);
            }
            
            actionMenuOpenForUserId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid ändring av admin-status: {ex.Message}";
            StateHasChanged();
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task ResetPassword(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "password";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            var token = await UserManager.GeneratePasswordResetTokenAsync(u);
            await UserManager.ResetPasswordAsync(u, token, "Test1234!");
            actionMenuOpenForUserId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid lösenordsåterställning: {ex.Message}";
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task DeleteUser(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "delete";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            await UserManager.DeleteAsync(u);
            
            users.RemoveAll(u => u.Id == userId);
            adminIds.Remove(userId);
            actionMenuOpenForUserId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid radering: {ex.Message}";
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task Impersonate(string userId)
    {
        actionMenuOpenForUserId = null;
        StateHasChanged();
        await new HttpClient().PostAsync(Nav.ToAbsoluteUri($"/auth/impersonate/{userId}"), null);
        Nav.NavigateTo("/", forceLoad: true);
    }
}
