@page "/admin"
@using Microsoft.AspNetCore.Identity
@using SchedulerMVP.Data.Entities
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Nav
@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI
@inject SchedulerMVP.Services.IEmailService EmailService
@inject SchedulerMVP.Services.IModalService ModalService

<div class="sa-panel" style="padding:16px; overflow-y: auto; overflow-x: hidden; padding-bottom: 64px;">
    <!-- Tab Navigation -->
    <div class="nav-tabs" style="margin-bottom:20px;">
        <button class="nav-tab @(activeTab == "users" ? "active" : "")" @onclick='() => SetActiveTab("users")'>Användare</button>
        <button class="nav-tab @(activeTab == "modals" ? "active" : "")" @onclick='() => SetActiveTab("modals")'>Modaler</button>
    </div>

    @if (activeTab == "users")
    {
        @if (isLoading)
        {
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: admin-spin 0.8s linear infinite;"></div>
                <div style="font-size: 14px; color: #6b7280;">Läser in användare...</div>
            </div>
        }

        <!-- Create User Button -->
        <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
            <button class="tb-btn" @onclick="OpenCreateUserModal">
                <span class="material-symbols-outlined" style="font-size:18px;">add</span>
                Skapa användare
            </button>
        </div>

        <!-- Users table -->
        <h3 class="groups-table-title" style="margin-bottom:12px;">Användare</h3>
    <div class="groups-table-container">
        <table class="groups-table">
            <thead>
                <tr>
                    <th>E-post</th>
                    <th>Senast inloggad</th>
                    <th>Admin</th>
                    <th>Status</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in users)
                {
                    var isAdmin = adminIds.Contains(u.Id);
                    var hasInvitationSent = !u.EmailConfirmed && string.IsNullOrEmpty(u.PasswordHash);
                    <tr>
                        <td>@u.Email</td>
                        <td>@FormatLastLogin(u.LastLoginAt)</td>
                        <td>
                            @if (isAdmin)
                            {
                                <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#d1fae5; color:#065f46; border:1px solid #6ee7b7;">Ja</span>
                            }
                            else
                            {
                                <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#f3f4f6; color:#6b7280;">Nej</span>
                            }
                        </td>
                        <td>
                            @if (hasInvitationSent)
                            {
                                <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#dbeafe; color:#1e40af; border:1px solid #93c5fd;">Inbjudan skickad</span>
                            }
                            else
                            {
                                <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#d1fae5; color:#065f46; border:1px solid #6ee7b7;">Aktiv</span>
                            }
                        </td>
                        <td style="position:relative;">
                            <button class="action-menu-trigger" @onclick="() => ToggleActionMenu(u.Id)" @onclick:stopPropagation="true">
                                <span class="material-symbols-outlined">more_vert</span>
                            </button>
                            @if (actionMenuOpenForUserId == u.Id)
                            {
                                <div class="action-menu" @onclick:stopPropagation="true">
                                    @if (hasInvitationSent)
                                    {
                                        <button class="action-menu-item" @onclick="() => ResendInvitation(u.Id)" disabled="@(isProcessing.Contains(u.Id))">
                                            @(isProcessing.Contains(u.Id) && processingAction.ContainsKey(u.Id) && processingAction[u.Id] == "resend" ? "Skickar..." : "Skicka om inbjudan")
                                        </button>
                                    }
                                    <button class="action-menu-item" @onclick="() => Impersonate(u.Id)" disabled="@(isProcessing.Contains(u.Id))">Logga in som</button>
                                    <button class="action-menu-item" @onclick="() => ToggleAdmin(u.Id)" disabled="@(isProcessing.Contains(u.Id))">
                                        @(isProcessing.Contains(u.Id) && processingAction.ContainsKey(u.Id) && processingAction[u.Id] == "admin" ? "Uppdaterar..." : (isAdmin ? "Ta bort admin" : "Gör admin"))
                                    </button>
                                    <button class="action-menu-item" @onclick="() => ResetPassword(u.Id)" disabled="@(isProcessing.Contains(u.Id))">Nytt lösenord</button>
                                    <button class="action-menu-item" style="color:#dc2626;" @onclick="() => DeleteUser(u.Id)" disabled="@(isProcessing.Contains(u.Id))">Radera</button>
                                </div>
                                <div class="menu-overlay" @onclick="CloseActionMenu"></div>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    }
    else if (activeTab == "modals")
    {
        <!-- Modals tab content will be added here -->
        <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
            <button class="tb-btn" @onclick="OpenCreateModalModal">
                <span class="material-symbols-outlined" style="font-size:18px;">add</span>
                Ny modal
            </button>
        </div>

        <h3 class="groups-table-title" style="margin-bottom:12px;">Modaler</h3>
        <div class="groups-table-container">
            <table class="groups-table">
                <thead>
                    <tr>
                        <th>Modalnamn</th>
                        <th>Status</th>
                        <th>Visningsdatum</th>
                        <th>Läst av</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var modal in modals)
                    {
                        var today = DateOnly.FromDateTime(DateTime.UtcNow);
                        var isActive = modal.StartDate <= today && modal.EndDate >= today;
                        var readCount = readCounts.ContainsKey(modal.Id) ? readCounts[modal.Id] : 0;
                        <tr>
                            <td>@modal.Title</td>
                            <td>
                                @if (isActive)
                                {
                                    <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#d1fae5; color:#065f46; border:1px solid #6ee7b7;">Aktiv</span>
                                }
                                else
                                {
                                    <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; background:#f3f4f6; color:#6b7280;">Inaktiv</span>
                                }
                            </td>
                            <td>@modal.StartDate.ToString("yyyy-MM-dd") - @modal.EndDate.ToString("yyyy-MM-dd")</td>
                            <td>@readCount</td>
                            <td style="position:relative;">
                                <button class="action-menu-trigger" @onclick="() => ToggleModalActionMenu(modal.Id)" @onclick:stopPropagation="true">
                                    <span class="material-symbols-outlined">more_vert</span>
                                </button>
                                @if (modalActionMenuOpenForId == modal.Id)
                                {
                                    <div class="action-menu" @onclick:stopPropagation="true">
                                        <button class="action-menu-item" @onclick="() => OpenEditModalModal(modal.Id)">Redigera</button>
                                        <button class="action-menu-item" style="color:#dc2626;" @onclick="() => OpenDeleteModalModal(modal.Id)">Ta bort</button>
                                    </div>
                                    <div class="menu-overlay" @onclick="CloseModalActionMenu"></div>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<CreateUserModal IsOpen="@createUserModalOpen" OnClose="CloseCreateUserModal" OnCreated="AfterUserCreated" />
<ModalManageModal IsOpen="@(createModalModalOpen || editModalModalOpen)" OnClose="@(createModalModalOpen ? CloseCreateModalModal : CloseEditModalModal)" OnSaved="AfterModalSaved" ModalId="@editingModalId" />
<ModalDeleteModal IsOpen="@deleteModalModalOpen" Modal="@(deletingModalId.HasValue ? modals.FirstOrDefault(m => m.Id == deletingModalId.Value) : null)" OnClose="CloseDeleteModalModal" OnDeleted="AfterModalDeleted" />

<style>
    @@keyframes admin-spin {
        to { transform: rotate(360deg); }
    }

    .groups-table-container {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: visible !important;
        min-height: fit-content;
    }

    .groups-table-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
        padding: 0;
    }

    .groups-table {
        width: 100%;
        border-collapse: collapse;
        display: table;
    }

    .groups-table thead {
        background: #F9FAFB;
    }

    .groups-table th {
        padding: 12px 20px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #6B7280;
        border-bottom: 1px solid #e5e7eb;
    }

    .groups-table tbody tr {
        border-bottom: 1px solid #f3f4f6;
    }

    .groups-table tbody tr:last-child {
        border-bottom: none;
    }

    .groups-table td {
        padding: 12px 20px;
        font-size: 14px;
        color: #111827;
    }

    .action-menu-trigger {
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6B7280;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .action-menu-trigger:hover {
        background: #f3f4f6;
    }

    .action-menu-trigger .material-symbols-outlined {
        font-size: 20px;
    }

    .action-menu {
        position: absolute;
        top: 32px;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        padding: 8px;
        min-width: 180px;
        white-space: nowrap;
        z-index: 1000;
    }

    .action-menu-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        background: transparent;
        font-size: 13px;
        cursor: pointer;
        text-align: left;
        color: #111827;
        transition: background 0.2s;
    }

    .action-menu-item:hover:not(:disabled) {
        background: #f1f5f9;
    }

    .action-menu-item:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .menu-overlay {
        position: fixed;
        inset: 0;
        z-index: 999;
    }
</style>

@code {
    private List<ApplicationUser> users = new();
    private HashSet<string> adminIds = new();
    private string? errorMessage;
    private bool isLoading = true;
    private bool createUserModalOpen = false;
    private HashSet<string> isProcessing = new();
    private Dictionary<string, string> processingAction = new();
    private string? actionMenuOpenForUserId;
    
    // Tab state
    private string activeTab = "users";
    
    // Modals state
    private List<Modal> modals = new();
    private Dictionary<Guid, int> readCounts = new();
    private bool createModalModalOpen = false;
    private bool editModalModalOpen = false;
    private bool deleteModalModalOpen = false;
    private Guid? editingModalId = null;
    private Guid? deletingModalId = null;
    private Guid? modalActionMenuOpenForId = null;

    protected override async Task OnInitializedAsync()
    {
        UI.IsAdminPage = true;
        UI.PageTitle = "Admin";
        await LoadAsync();
        await LoadModalsAsync();
    }

    public void Dispose()
    {
        UI.IsAdminPage = false;
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            await Task.Delay(100);
            
            users = UserManager.Users.OrderBy(u => u.Email).ToList();
            
            var adminRole = await RoleManager.FindByNameAsync("Admin");
            if (adminRole != null)
            {
                var adminCheckTasks = users.Select(async u => new { Id = u.Id, IsAdmin = await UserManager.IsInRoleAsync(u, "Admin") });
                var results = await Task.WhenAll(adminCheckTasks);
                adminIds = new HashSet<string>(results.Where(r => r.IsAdmin).Select(r => r.Id));
            }
            else
            {
                adminIds = new HashSet<string>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid laddning: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private static string FormatLastLogin(DateTimeOffset? ts) => ts.HasValue ? ts.Value.LocalDateTime.ToString("yyyy-MM-dd HH:mm") : "—";

    private void OpenCreateUserModal()
    {
        createUserModalOpen = true;
        StateHasChanged();
    }
    
    private void CloseCreateUserModal()
    {
        createUserModalOpen = false;
        StateHasChanged();
    }
    
    private async Task AfterUserCreated()
    {
        await LoadAsync();
        CloseCreateUserModal();
    }

    private void ToggleActionMenu(string userId)
    {
        if (actionMenuOpenForUserId == userId)
        {
            actionMenuOpenForUserId = null;
        }
        else
        {
            actionMenuOpenForUserId = userId;
        }
        StateHasChanged();
    }

    private void CloseActionMenu()
    {
        actionMenuOpenForUserId = null;
        StateHasChanged();
    }

    private async Task ToggleAdmin(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "admin";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            
            var wasAdmin = await UserManager.IsInRoleAsync(u, "Admin");
            if (wasAdmin)
            {
                await UserManager.RemoveFromRoleAsync(u, "Admin");
                adminIds.Remove(userId);
            }
            else
            {
                await UserManager.AddToRoleAsync(u, "Admin");
                adminIds.Add(userId);
            }
            
            actionMenuOpenForUserId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid ändring av admin-status: {ex.Message}";
            StateHasChanged();
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task ResetPassword(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "password";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            var token = await UserManager.GeneratePasswordResetTokenAsync(u);
            await UserManager.ResetPasswordAsync(u, token, "Test1234!");
            actionMenuOpenForUserId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid lösenordsåterställning: {ex.Message}";
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task DeleteUser(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "delete";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            await UserManager.DeleteAsync(u);
            
            users.RemoveAll(u => u.Id == userId);
            adminIds.Remove(userId);
            actionMenuOpenForUserId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid radering: {ex.Message}";
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task Impersonate(string userId)
    {
        actionMenuOpenForUserId = null;
        StateHasChanged();
        await new HttpClient().PostAsync(Nav.ToAbsoluteUri($"/auth/impersonate/{userId}"), null);
        Nav.NavigateTo("/", forceLoad: true);
    }

    private async Task ResendInvitation(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "resend";
        CloseActionMenu();
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                StateHasChanged();
                return;
            }

            // Check if user should receive invitation (not confirmed and no password)
            if (u.EmailConfirmed || !string.IsNullOrEmpty(u.PasswordHash))
            {
                errorMessage = "Användaren är redan aktiverad och behöver ingen inbjudan.";
                StateHasChanged();
                return;
            }

            // Generate new email confirmation token
            var token = await UserManager.GenerateEmailConfirmationTokenAsync(u);
            
            // Get base URL for confirmation link
            var baseUrl = Nav.BaseUri.TrimEnd('/');
            
            // Send invitation email
            await EmailService.SendInvitationEmailAsync(u.Email!, token, baseUrl);
            
            // Show success message briefly
            errorMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid återutsändning av inbjudan: {ex.Message}";
            StateHasChanged();
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task LoadModalsAsync()
    {
        // #region agent log
        try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D", location = "Admin.razor:583", message = "LoadModalsAsync entry", data = new { activeTab = activeTab }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
        // #endregion
        
        try
        {
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D", location = "Admin.razor:587", message = "Before GetAllModalsAsync", data = new { }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            
            modals = await ModalService.GetAllModalsAsync();
            
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D,C", location = "Admin.razor:590", message = "After GetAllModalsAsync", data = new { count = modals.Count, firstTitle = modals.FirstOrDefault()?.Title ?? "null" }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            
            readCounts.Clear();
            foreach (var modal in modals)
            {
                readCounts[modal.Id] = await ModalService.GetReadCountAsync(modal.Id);
            }
            StateHasChanged();
            
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D", location = "Admin.razor:599", message = "LoadModalsAsync exit success", data = new { modalsCount = modals.Count, readCountsCount = readCounts.Count }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
        }
        catch (Exception ex)
        {
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "B,D", location = "Admin.razor:603", message = "LoadModalsAsync exception", data = new { exceptionType = ex.GetType().Name, message = ex.Message, stackTrace = ex.StackTrace?.Substring(0, Math.Min(500, ex.StackTrace.Length ?? 0)) }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            errorMessage = $"Fel vid laddning av modaler: {ex.Message}";
            StateHasChanged();
        }
    }

    private void OpenCreateModalModal()
    {
        editingModalId = null;
        createModalModalOpen = true;
        StateHasChanged();
    }

    private void OpenEditModalModal(Guid modalId)
    {
        modalActionMenuOpenForId = null;
        editingModalId = modalId;
        editModalModalOpen = true;
        StateHasChanged();
    }

    private void OpenDeleteModalModal(Guid modalId)
    {
        modalActionMenuOpenForId = null;
        deletingModalId = modalId;
        deleteModalModalOpen = true;
        StateHasChanged();
    }

    private void CloseCreateModalModal()
    {
        createModalModalOpen = false;
        StateHasChanged();
    }

    private void CloseEditModalModal()
    {
        editModalModalOpen = false;
        editingModalId = null;
        StateHasChanged();
    }

    private void CloseDeleteModalModal()
    {
        deleteModalModalOpen = false;
        deletingModalId = null;
        StateHasChanged();
    }

    private async Task AfterModalSaved()
    {
        await LoadModalsAsync();
        CloseCreateModalModal();
        CloseEditModalModal();
    }

    private async Task AfterModalDeleted()
    {
        await LoadModalsAsync();
        CloseDeleteModalModal();
    }

    private void ToggleModalActionMenu(Guid modalId)
    {
        if (modalActionMenuOpenForId == modalId)
        {
            modalActionMenuOpenForId = null;
        }
        else
        {
            modalActionMenuOpenForId = modalId;
        }
        StateHasChanged();
    }

    private void CloseModalActionMenu()
    {
        modalActionMenuOpenForId = null;
        StateHasChanged();
    }
}
