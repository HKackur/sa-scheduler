@page "/admin"
@using Microsoft.AspNetCore.Identity
@using SchedulerMVP.Data.Entities
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Nav
@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI

<PageTitle>Admin</PageTitle>

@if (isLoading)
{
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 12px;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: admin-spin 0.8s linear infinite;"></div>
        <div style="font-size: 14px; color: #6b7280;">Läser in användare...</div>
    </div>
}

<div class="sa-panel" style="margin:16px; @(isLoading ? "opacity:0.5; pointer-events:none;" : "")">
    <div class="sa-panel-header" style="display:flex;align-items:center;gap:12px;">
        <h6 class="sa-panel-title">Användare</h6>
    </div>

    <div class="sa-panel-content" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
        <div style="flex:1 1 320px;max-width:520px;">
            <div style="margin-bottom:12px;font-weight:600;">Skapa testkonto</div>
            <form @onsubmit="CreateUser" @onsubmit:preventDefault>
                <div class="sa-input-group">
                    <label class="sa-input-label">E-post</label>
                    <input type="email" placeholder="E-post" @bind="newEmail" class="sa-input-field" required />
                </div>
                <div class="sa-input-group">
                    <label class="sa-input-label">Lösenord</label>
                    <input type="password" placeholder="Lösenord" @bind="newPassword" class="sa-input-field" minlength="8" required />
                    <div style="color:#6b7280;font-size:12px;margin-top:4px;">Minst 8 tecken.</div>
                </div>
                <button class="tb-action-btn" type="submit" disabled="@(!CanSubmit || isCreatingUser)"><span class="action-text">@(isCreatingUser ? "Skapar..." : "Skapa")</span></button>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div style="margin-top:8px;color:#b91c1c;font-size:13px;">@errorMessage</div>
                }
            </form>
        </div>

        <div style="flex:2 1 520px;min-width:420px;">
            <table style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr style="text-align:left;border-bottom:1px solid #e5e7eb;">
                        <th style="padding:8px;">E-post</th>
                        <th style="padding:8px;">Senast inloggad</th>
                        <th style="padding:8px;">Admin</th>
                        <th style="padding:8px;text-align:right;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var u in users)
                    {
                        var isAdmin = adminIds.Contains(u.Id);
                        <tr style="border-bottom:1px solid #f1f5f9;">
                            <td style="padding:8px;">@u.Email</td>
                            <td style="padding:8px;color:#6b7280;">@FormatLastLogin(u.LastLoginAt)</td>
                            <td style="padding:8px;">@(isAdmin ? "Ja" : "Nej")</td>
                            <td style="padding:8px;display:flex;gap:8px;justify-content:flex-end;">
                                <button class="tb-action-btn" @onclick="() => Impersonate(u.Id)" disabled="@(isProcessing.Contains(u.Id))"><span class="action-text">Logga in som</span></button>
                                <button class="tb-action-btn" @onclick="() => ToggleAdmin(u.Id)" disabled="@(isProcessing.Contains(u.Id))"><span class="action-text">@(isProcessing.Contains(u.Id) && processingAction[u.Id] == "admin" ? "Uppdaterar..." : isAdmin?"Ta bort admin":"Gör admin")</span></button>
                                <button class="tb-action-btn" @onclick="() => ResetPassword(u.Id)" disabled="@(isProcessing.Contains(u.Id))"><span class="action-text">Nytt lösen</span></button>
                                <button class="tb-action-btn" @onclick="() => DeleteUser(u.Id)" disabled="@(isProcessing.Contains(u.Id))" style="background:#fee2e2;"><span class="action-text">Radera</span></button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    @@keyframes admin-spin {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    private List<ApplicationUser> users = new();
    private HashSet<string> adminIds = new();
    private string newEmail = string.Empty;
    private string newPassword = string.Empty;
    private string? errorMessage;
    private bool isLoading = true;
    private bool isCreatingUser = false;
    private HashSet<string> isProcessing = new();
    private Dictionary<string, string> processingAction = new();
    private bool CanSubmit => !string.IsNullOrWhiteSpace(newEmail) && !string.IsNullOrWhiteSpace(newPassword) && newPassword.Length >= 8;

    protected override async Task OnInitializedAsync()
    {
        UI.IsAdminPage = true;
        UI.PageTitle = "Admin";
        await LoadAsync();
    }

    public void Dispose()
    {
        UI.IsAdminPage = false;
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            // Add a small delay to ensure any previous DbContext operations are complete
            // This helps avoid "second operation started" errors
            await Task.Delay(100);
            
            // PERF: Load users efficiently - use ToListAsync if available, otherwise ToList
            // Note: UserManager.Users is IQueryable, but Identity doesn't always support async enumeration
            // So we'll use ToList() but optimize the admin check
            
            users = UserManager.Users.OrderBy(u => u.Email).ToList();
            
            // PERF: Optimize admin check - check all users in parallel
            var adminRole = await RoleManager.FindByNameAsync("Admin");
            if (adminRole != null)
            {
                // Check all users in parallel for better performance
                var adminCheckTasks = users.Select(async u => new { Id = u.Id, IsAdmin = await UserManager.IsInRoleAsync(u, "Admin") });
                var results = await Task.WhenAll(adminCheckTasks);
                adminIds = new HashSet<string>(results.Where(r => r.IsAdmin).Select(r => r.Id));
            }
            else
            {
                adminIds = new HashSet<string>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid laddning: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private static string FormatLastLogin(DateTimeOffset? ts) => ts.HasValue ? ts.Value.LocalDateTime.ToString("yyyy-MM-dd HH:mm") : "—";

    private async Task CreateUser()
    {
        errorMessage = null;
        if (string.IsNullOrWhiteSpace(newEmail) || string.IsNullOrWhiteSpace(newPassword)) 
        { 
            errorMessage = "Fyll i e‑post och lösenord."; 
            StateHasChanged();
            return; 
        }
        if (newPassword.Length < 8) 
        { 
            errorMessage = "Lösenordet måste vara minst 8 tecken."; 
            StateHasChanged();
            return; 
        }
        
        isCreatingUser = true;
        StateHasChanged();
        
        try
        {
            var user = new ApplicationUser { UserName = newEmail, Email = newEmail, EmailConfirmed = true };
            var res = await UserManager.CreateAsync(user, newPassword);
            if (res.Succeeded)
            {
                newEmail = string.Empty; 
                newPassword = string.Empty;
                
                // Give Identity DbContext time to complete the transaction
                await Task.Delay(100);
                
                // Create template synchronously to avoid DbContext conflicts
                // Use a timeout to prevent blocking if it takes too long
                try 
                { 
                    var templateTask = TemplateService.CreateForUserAsync(user.Id, "Veckomall");
                    var timeoutTask = Task.Delay(5000); // 5 second timeout
                    var completedTask = await Task.WhenAny(templateTask, timeoutTask);
                    if (completedTask == timeoutTask)
                    {
                        // Template creation timed out, but user was created successfully
                        // Continue with reload
                    }
                    else
                    {
                        await templateTask; // Ensure any exceptions are handled
                    }
                } 
                catch (Exception templateEx) 
                { 
                    // Log but don't fail user creation - template can be created later
                    Console.WriteLine($"Warning: Failed to create template for user {user.Email}: {templateEx.Message}");
                }
                
                // Give a small delay before reloading to ensure all operations are complete
                await Task.Delay(50);
                
                // Reload data after template creation is complete (or timed out)
                await LoadAsync();
            }
            else
            {
                errorMessage = string.Join("; ", res.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid skapande: {ex.Message}";
        }
        finally
        {
            isCreatingUser = false;
            StateHasChanged();
        }
    }

    private async Task ToggleAdmin(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "admin";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            
            var wasAdmin = await UserManager.IsInRoleAsync(u, "Admin");
            if (wasAdmin)
            {
                await UserManager.RemoveFromRoleAsync(u, "Admin");
            }
            else
            {
                await UserManager.AddToRoleAsync(u, "Admin");
            }
            
            // PERF: Update adminIds immediately without full reload
            if (wasAdmin)
            {
                adminIds.Remove(userId);
            }
            else
            {
                adminIds.Add(userId);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid ändring av admin-status: {ex.Message}";
            StateHasChanged();
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task ResetPassword(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "password";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            var token = await UserManager.GeneratePasswordResetTokenAsync(u);
            await UserManager.ResetPasswordAsync(u, token, "Test1234!");
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid lösenordsåterställning: {ex.Message}";
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private async Task DeleteUser(string userId)
    {
        if (isProcessing.Contains(userId)) return;
        
        isProcessing.Add(userId);
        processingAction[userId] = "delete";
        StateHasChanged();
        
        try
        {
            var u = await UserManager.FindByIdAsync(userId);
            if (u == null)
            {
                errorMessage = "Användare hittades inte.";
                return;
            }
            await UserManager.DeleteAsync(u);
            
            // PERF: Remove from local lists immediately
            users.RemoveAll(u => u.Id == userId);
            adminIds.Remove(userId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid radering: {ex.Message}";
        }
        finally
        {
            isProcessing.Remove(userId);
            processingAction.Remove(userId);
            StateHasChanged();
        }
    }

    private void GoHome() => Nav.NavigateTo("/");

    private async Task Impersonate(string userId)
    {
        // POST to our endpoint
        await new HttpClient().PostAsync(Nav.ToAbsoluteUri($"/auth/impersonate/{userId}"), null);
        Nav.NavigateTo("/", forceLoad: true);
    }
}


