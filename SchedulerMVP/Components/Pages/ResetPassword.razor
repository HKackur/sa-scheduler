@page "/reset-password"
@layout Layout.LoginLayout
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.WebUtilities
@using SchedulerMVP.Data.Entities
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Återställ lösenord</PageTitle>

<div class="login-page">
    <header class="login-logo" aria-label="Sportadmin Labs">
        <img class="login-logo-primary" src="Sportadmin Labs Logo.png" alt="Sportadmin Labs" />
    </header>

    <section class="login-content" aria-labelledby="reset-heading">
        @if (isSuccess)
        {
            <div class="login-text">
                <h1 id="reset-heading">Lösenord återställt</h1>
                <p>Ditt lösenord har återställts. Du kan nu logga in med ditt nya lösenord.</p>
            </div>
            <div class="login-form">
                <button type="button" class="login-button" @onclick="GoToLogin">
                    Logga in
                </button>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="login-text">
                <h1 id="reset-heading">Fel vid återställning</h1>
                <p>@errorMessage</p>
            </div>
            <div class="login-form">
                @if (errorMessage.Contains("Länken") || errorMessage.Contains("giltig"))
                {
                    <div class="forgot-password-link">
                        <a href="/forgot-password">Begär ny återställningslänk</a>
                    </div>
                }
                <button type="button" class="login-button" @onclick="GoToLogin">
                    Tillbaka till inloggning
                </button>
            </div>
        }
        else
        {
            <div class="login-text">
                <h1 id="reset-heading">Återställ ditt lösenord</h1>
                <p>Ange ditt nya lösenord för <strong>@email</strong></p>
            </div>

            <div class="login-form">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message" role="alert">@errorMessage</div>
                }

                <form @onsubmit:preventDefault="true">
                    <div class="form-group">
                        <label for="password">Nytt lösenord</label>
                        <input id="password" name="password" class="form-control" type="password" @bind="password" placeholder="Ange nytt lösenord (minst 8 tecken)" required />
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">Minst 8 tecken.</div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Bekräfta lösenord</label>
                        <input id="confirmPassword" name="confirmPassword" class="form-control" type="password" @bind="confirmPassword" placeholder="Bekräfta nytt lösenord" required />
                    </div>

                    <button type="button" class="login-button" @onclick="HandleResetPassword" disabled="@(string.IsNullOrWhiteSpace(password) || string.IsNullOrWhiteSpace(confirmPassword) || password.Length < 8 || isProcessing)">
                        @if (isProcessing)
                        {
                            <span>Återställer...</span>
                        }
                        else
                        {
                            <span>Återställ lösenord</span>
                        }
                    </button>
                </form>
                
                <div class="forgot-password-link">
                    <a href="/login">Tillbaka till inloggning</a>
                </div>
            </div>
        }
    </section>
</div>

@code {
    [Parameter, SupplyParameterFromQuery] public string? Token { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? Email { get; set; }

    private string email = string.Empty;
    private string password = string.Empty;
    private string confirmPassword = string.Empty;
    private bool isProcessing = false;
    private bool isSuccess = false;
    private string errorMessage = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Force hide TopBar with JavaScript after render
            await JS.InvokeVoidAsync("eval", @"
                (function() {
                    const hideTopBar = () => {
                        const topBar = document.querySelector('.sa-topbar');
                        if (topBar) {
                            topBar.style.cssText = 'display:none!important;visibility:hidden!important;height:0!important;overflow:hidden!important;position:absolute!important;left:-99999px!important;opacity:0!important;';
                        }
                    };
                    hideTopBar();
                    setTimeout(hideTopBar, 100);
                    setTimeout(hideTopBar, 500);
                })();
            ");
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override void OnInitialized()
    {
        // Get token and email from query parameters
        try
        {
            var uri = new Uri(Navigation.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);
            
            if (query.TryGetValue("token", out var tokenValue))
            {
                Token = tokenValue.ToString();
            }
            
            if (query.TryGetValue("email", out var emailValue))
            {
                Email = emailValue.ToString();
                email = Uri.UnescapeDataString(Email);
            }
            
            // Check for error parameter
            if (query.TryGetValue("error", out var errorValue))
            {
                var errorCode = errorValue.ToString();
                errorMessage = errorCode switch
                {
                    "missing" => "Alla fält måste fyllas i.",
                    "passwordmismatch" => "Lösenorden matchar inte.",
                    "passwordtooshort" => "Lösenordet måste vara minst 8 tecken.",
                    "invalid" => "Ogiltig återställningslänk. Användaren hittades inte.",
                    "invalidtoken" => "Länken är ogiltig eller har gått ut. Begär en ny återställningslänk.",
                    "error" => "Ett fel uppstod. Försök igen eller kontakta support.",
                    _ => "Ett fel uppstod. Försök igen."
                };
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Ett fel uppstod vid läsning av länk.";
        }

        if (string.IsNullOrEmpty(Token) || string.IsNullOrEmpty(Email))
        {
            errorMessage = "Ogiltig återställningslänk. Token eller e-postadress saknas.";
        }
    }

    private async Task HandleResetPassword()
    {
        if (string.IsNullOrWhiteSpace(password) || string.IsNullOrWhiteSpace(confirmPassword))
        {
            errorMessage = "Fyll i båda lösenordsfälten.";
            StateHasChanged();
            return;
        }

        if (password.Length < 8)
        {
            errorMessage = "Lösenordet måste vara minst 8 tecken.";
            StateHasChanged();
            return;
        }

        if (password != confirmPassword)
        {
            errorMessage = "Lösenorden matchar inte.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(Token) || string.IsNullOrWhiteSpace(Email))
        {
            errorMessage = "Ogiltig återställningslänk.";
            StateHasChanged();
            return;
        }

        isProcessing = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Call backend endpoint to reset password
            var formData = new List<KeyValuePair<string, string>>
            {
                new("email", Email),
                new("token", Token),
                new("password", password),
                new("confirmPassword", confirmPassword)
            };

            var response = await new HttpClient().PostAsync(
                $"{Navigation.BaseUri.TrimEnd('/')}/auth/reset-password",
                new FormUrlEncodedContent(formData)
            );

            if (response.IsSuccessStatusCode || response.StatusCode == System.Net.HttpStatusCode.Redirect)
            {
                // Check if redirected to login with success
                var location = response.Headers.Location?.ToString();
                if (location?.Contains("reset=success") == true)
                {
                    isSuccess = true;
                }
                else
                {
                    // Follow redirect
                    Navigation.NavigateTo(location ?? "/login?reset=success");
                }
            }
            else
            {
                errorMessage = "Ett fel uppstod vid återställning. Försök igen.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Ett fel uppstod. Försök igen eller kontakta support.";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}

