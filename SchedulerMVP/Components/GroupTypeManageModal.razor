@using Microsoft.EntityFrameworkCore
@using SchedulerMVP.Data
@inject IDbContextFactory<AppDbContext> DbFactory
@inject SchedulerMVP.Services.IGroupTypeService GroupTypes
@inject SchedulerMVP.Services.UserContextService UserContext

@if (IsOpen)
{
    <div class="modal-container" @onclick="OnBackdrop">
        <div class="bm-modal" @onclick:stopPropagation="true">
            <div class="bm-header">
                <h2 class="bm-title">@(EditingGroupType != null ? "Redigera grupptyp" : "Skapa ny grupptyp")</h2>
            </div>
            <div class="bm-field">
                <label class="bm-label">Grupptypnamn</label>
                <input class="bm-input" @bind="groupTypeName" />
            </div>
            <div class="bm-field">
                <label class="bm-label">Standard visningsfärg</label>
                <select class="bm-input" @bind="standardDisplayColor" @bind:event="onchange">
                    @foreach (var color in SchedulerMVP.Data.Entities.GroupDisplayColors.Colors.Keys)
                    {
                        <option value="@color">@color</option>
                    }
                </select>
            </div>
            @if (EditingGroupType != null)
            {
                <div class="bm-field">
                    <label class="bm-label" style="margin-bottom:8px;">Vid uppdatering av visningsfärg</label>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:400;">
                            <input type="radio" name="colorUpdateMode" checked="@(colorUpdateMode == "updateAll")" @onchange='() => colorUpdateMode = "updateAll"' style="cursor:pointer;" />
                            <span>Uppdatera alla befintliga gruppers visningsfärg</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:400;">
                            <input type="radio" name="colorUpdateMode" checked="@(colorUpdateMode == "newOnly")" @onchange='() => colorUpdateMode = "newOnly"' style="cursor:pointer;" />
                            <span>Använd endast visningsfärgen på nya grupper</span>
                        </label>
                    </div>
                </div>
            }
            <div class="bm-actions">
                <button type="button" @onclick="OnCancel" class="btn-outline">Avbryt</button>
                <button type="button" @onclick="OnSave" class="btn-primary" disabled="@string.IsNullOrWhiteSpace(groupTypeName)">@(EditingGroupType != null ? "Spara" : "Skapa grupptyp")</button>
            </div>
        </div>
    </div>
    <style>
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px 28px 0 28px;border:1px solid #e6e7ea;border-radius:12px;width:480px;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
        .bm-header{margin-bottom:20px}
        .bm-title{font-size:18px;font-weight:700;color:#0f1720;margin:0}
        .bm-field{margin-bottom:16px}
        .bm-label{display:block;font-size:12px;font-weight:500;color:#374151;margin-bottom:6px}
        .bm-input{width:100%;padding:10px 12px;border-radius:4px;border:1px solid #dcdee2;background-color:#f3f5f7;box-shadow:0 2px 8px 0 rgba(0,0,0,0.02);font-size:12px;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;box-sizing:border-box;min-height:40px}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px;position:sticky;bottom:0;background:#fff;border-top:1px solid #e6e7ea;padding-top:12px;padding-bottom:28px;z-index:10}
    </style>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public SchedulerMVP.Data.Entities.GroupType? EditingGroupType { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private string groupTypeName = string.Empty;
    private string standardDisplayColor = "Ljusblå";
    private string colorUpdateMode = "newOnly";

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen)
        {
            if (EditingGroupType != null)
            {
                groupTypeName = EditingGroupType.Name;
                standardDisplayColor = EditingGroupType.StandardDisplayColor ?? "Ljusblå";
                colorUpdateMode = "newOnly";
            }
            else
            {
                groupTypeName = string.Empty;
                standardDisplayColor = "Ljusblå";
                colorUpdateMode = "newOnly";
            }
        }
    }

    private void OnBackdrop()
    {
        OnCancel();
    }

    private void OnCancel()
    {
        groupTypeName = string.Empty;
        standardDisplayColor = "Ljusblå";
        colorUpdateMode = "newOnly";
        OnClose.InvokeAsync();
    }

    private async Task OnSave()
    {
        try
        {
            var name = (groupTypeName ?? string.Empty).Trim();
            if (string.IsNullOrEmpty(name)) return;
            
            await using var db = await DbFactory.CreateDbContextAsync();
            
            if (EditingGroupType != null)
            {
                // Update existing group type
                var gt = await db.GroupTypes.FindAsync(EditingGroupType.Id);
                if (gt == null) return;
                
                var oldColor = gt.StandardDisplayColor;
                gt.Name = name;
                gt.StandardDisplayColor = standardDisplayColor;
                
                // If updating all existing groups' colors
                if (colorUpdateMode == "updateAll" && oldColor != standardDisplayColor)
                {
                    var groups = await db.Groups.Where(g => g.GroupType == gt.Name).ToListAsync();
                    foreach (var g in groups)
                    {
                        g.DisplayColor = standardDisplayColor;
                    }
                }
                
                await db.SaveChangesAsync();
            }
            else
            {
                // Create new group type using service (ensures ClubId is set correctly)
                await GroupTypes.CreateAsync(name, standardDisplayColor);
            }
            
            groupTypeName = string.Empty;
            standardDisplayColor = "Ljusblå";
            colorUpdateMode = "newOnly";
            
            await OnSaved.InvokeAsync();
            await OnClose.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[GroupTypeManageModal] Error saving group type: {ex.Message}");
        }
    }
}
