@inject SchedulerMVP.Services.IScheduleTemplateService TemplateService
@inject SchedulerMVP.Services.UIState UI

@if (IsOpen)
{
    <div class="modal-container" @onclick="OnBackdrop">
        <div class="bm-modal" @onclick:stopPropagation="true">
            <div class="bm-header">
                <h2 class="bm-title">Ã„ndra veckomall</h2>
            </div>
            <div class="bm-field">
                <label class="bm-label">Mallnamn</label>
                <input class="bm-input" value="@name" @oninput="OnNameInput" />
            </div>
            <div class="bm-actions">
                <button type="button" @onclick="OnDelete" class="btn-danger-left">Radera mall</button>
                <div style="margin-left:auto;display:flex;gap:12px;">
                    <button type="button" @onclick="OnCancel" class="btn-outline">Avbryt</button>
                    <button type="button" @onclick="OnSave" class="btn-primary" disabled="@string.IsNullOrWhiteSpace(name)">Spara</button>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* Match booking modal exact structure and styling */
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px 28px 0 28px;border:1px solid #e6e7ea;border-radius:12px;min-width:560px;max-width:720px;width:90vw;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
        .bm-header{position:sticky;top:0;background:#fff;z-index:12;padding-bottom:12px;margin-bottom:0}
        .bm-input{width:100%;padding:10px 12px;border-radius:4px;border:1px solid #dcdee2;background-color:#f3f5f7;box-shadow:0 2px 8px 0 rgba(0,0,0,0.02);font-size:12px;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;box-sizing:border-box;min-height:40px}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px;position:sticky;bottom:0;background:#fff;padding-top:12px;padding-bottom:24px;z-index:10}
    </style>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnDeleteRequested { get; set; }

    private string name = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && UI.SelectedTemplateId is Guid id)
        {
            var t = await TemplateService.GetByIdAsync(id);
            name = t?.Name ?? string.Empty;
        }
    }

    private void OnNameInput(ChangeEventArgs e)
    {
        name = e.Value?.ToString() ?? string.Empty;
    }

    private async Task OnSave()
    {
        if (UI.SelectedTemplateId is Guid id)
        {
            await TemplateService.UpdateTemplateNameAsync(id, name);
            await OnSaved.InvokeAsync();
            await CloseAsync();
        }
    }

    private async Task OnCancel() => await CloseAsync();

    private async Task OnDelete()
    {
        await CloseAsync();
        if (OnDeleteRequested.HasDelegate)
        {
            await OnDeleteRequested.InvokeAsync();
        }
    }

    private async Task OnBackdrop(MouseEventArgs _)
    {
        await CloseAsync();
    }

    private async Task CloseAsync()
    {
        IsOpen = false;
        await OnClose.InvokeAsync();
    }
}
