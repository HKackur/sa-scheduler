@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Authorization
@using SchedulerMVP.Data.Entities
@inject NavigationManager Navigation
@inject SchedulerMVP.Services.IModalService ModalService
@inject SchedulerMVP.Services.UserContextService UserContext
@implements IDisposable

@{
    var isLoginPage = _isLoginPage;
}

@if (isLoginPage)
{
    @* Login page - render ONLY Body, NO TopBar, NO app-root wrapper *@
    <div style="min-height: 100vh; background-color: #f7f7f7;">
        @Body
    </div>
}
else
{
    @* Normal page - require auth; otherwise redirect to login *@
    <AuthorizeView>
        <Authorized>
            <div class="app-root" style="display: flex; flex-direction: column; height: 100vh;">
                <TopBar />
                <div style="flex: 1; overflow: @((_isWhatsNewPage || _isGroupsManagePage || _isHelpPage) ? "auto" : "hidden"); display: flex; flex-direction: column;">
                    @Body
                </div>
                <Toast />
                <ConnectionHealthCheck />
                @if (_currentModal != null)
                {
                    <UserModal Modal="@_currentModal" OnClosed="OnModalClosed" />
                }
            </div>
        </Authorized>
        <NotAuthorized>
            <RedirectToLogin />
        </NotAuthorized>
    </AuthorizeView>
}

@code {
    private bool _isLoginPage = false;
    private bool _isWhatsNewPage = false;
    private bool _isGroupsManagePage = false;
    private bool _isHelpPage = false;
    private Modal? _currentModal = null;
    private List<Modal> _pendingModals = new();
    private bool _modalsLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        UpdateLoginStatus();
        Navigation.LocationChanged += OnLocationChanged;
        await LoadModalsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isLoginPage)
        {
            await LoadModalsAsync();
        }
    }

    private void UpdateLoginStatus()
    {
        try
        {
            var uri = Navigation.Uri.ToLower();
            var path = new Uri(uri).AbsolutePath.ToLower();
            _isLoginPage = path == "/login" || path.EndsWith("/login");
            _isWhatsNewPage = path == "/vad-ar-nytt" || path.EndsWith("/vad-ar-nytt");
            _isGroupsManagePage = path == "/grupper" || path.EndsWith("/grupper");
            _isHelpPage = path == "/hjalp" || path.EndsWith("/hjalp");
        }
        catch
        {
            _isLoginPage = false;
            _isWhatsNewPage = false;
            _isGroupsManagePage = false;
            _isHelpPage = false;
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateLoginStatus();
        StateHasChanged();
    }

    private async Task LoadModalsAsync()
    {
        // #region agent log
        try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D,E", location = "MainLayout.razor:96", message = "LoadModalsAsync entry", data = new { isLoginPage = _isLoginPage, modalsLoaded = _modalsLoaded }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
        // #endregion
        
        if (_isLoginPage || _modalsLoaded)
        {
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D", location = "MainLayout.razor:99", message = "LoadModalsAsync early return", data = new { reason = _isLoginPage ? "isLoginPage" : "modalsLoaded" }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            return;
        }

        try
        {
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "E", location = "MainLayout.razor:105", message = "Before GetCurrentUserIdAsync", data = new { }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            
            var userId = await UserContext.GetCurrentUserIdAsync();
            
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "E", location = "MainLayout.razor:108", message = "After GetCurrentUserIdAsync", data = new { userId = userId ?? "null", userIdLength = userId?.Length ?? 0, isEmpty = string.IsNullOrEmpty(userId) }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            
            if (string.IsNullOrEmpty(userId))
            {
                // #region agent log
                try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "E", location = "MainLayout.razor:111", message = "LoadModalsAsync return - no userId", data = new { }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
                // #endregion
                return;
            }

            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D", location = "MainLayout.razor:116", message = "Before GetActiveModalsForUserAsync", data = new { userId = userId }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion

            // Get active modals for user (optimized query with indexes)
            var activeModals = await ModalService.GetActiveModalsForUserAsync(userId);
            
            // #region agent log
            try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "C,D", location = "MainLayout.razor:121", message = "After GetActiveModalsForUserAsync", data = new { count = activeModals.Count, firstId = activeModals.FirstOrDefault()?.Id.ToString() ?? "null" }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            
            _pendingModals = activeModals;
            _modalsLoaded = true;

            // Show first modal if any
            if (_pendingModals.Count > 0 && _currentModal == null)
            {
                _currentModal = _pendingModals[0];
                StateHasChanged();
                
                // #region agent log
                try { System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "D", location = "MainLayout.razor:128", message = "Modal set to show", data = new { modalId = _currentModal?.Id.ToString() ?? "null", modalTitle = _currentModal?.Title ?? "null" }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
                // #endregion
            }
        }
        catch (Exception ex)
        {
            // #region agent log
            try { var st = ex.StackTrace ?? ""; System.IO.File.AppendAllText("/Users/henrikkackur/SchedulerMVP/.cursor/debug.log", System.Text.Json.JsonSerializer.Serialize(new { sessionId = "debug-session", runId = "run1", hypothesisId = "B", location = "MainLayout.razor:135", message = "LoadModalsAsync exception", data = new { exceptionType = ex.GetType().Name, message = ex.Message, stackTrace = st.Length > 500 ? st.Substring(0, 500) : st }, timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() }) + "\n"); } catch { }
            // #endregion
            Console.WriteLine($"[MainLayout] Error loading modals: {ex.Message}");
        }
    }

    private async Task OnModalClosed()
    {
        if (_currentModal != null)
        {
            // Remove current modal from pending list
            _pendingModals.Remove(_currentModal);
            _currentModal = null;

            // Show next modal if any
            if (_pendingModals.Count > 0)
            {
                _currentModal = _pendingModals[0];
            }

            StateHasChanged();
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}


