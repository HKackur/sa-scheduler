@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@implements IDisposable

@{
    var isLoginPage = _isLoginPage;
}

@if (isLoginPage)
{
    @* Login page - render ONLY Body, NO TopBar, NO app-root wrapper *@
    <div style="min-height: 100vh; background-color: #f7f7f7;">
        @Body
    </div>
}
else
{
    @* Normal page - require auth; otherwise redirect to login *@
    <AuthorizeView>
        <Authorized>
            <div class="app-root" style="display: flex; flex-direction: column; height: 100vh;">
                <TopBar />
                <div style="flex: 1; overflow: @(_isWhatsNewPage ? "auto" : "hidden"); display: flex; flex-direction: column;">
                    @Body
                </div>
                <Toast />
            </div>
        </Authorized>
        <NotAuthorized>
            <RedirectToLogin />
        </NotAuthorized>
    </AuthorizeView>
}

@code {
    private bool _isLoginPage = false;
    private bool _isWhatsNewPage = false;

    protected override void OnInitialized()
    {
        UpdateLoginStatus();
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void UpdateLoginStatus()
    {
        try
        {
            var uri = Navigation.Uri.ToLower();
            var path = new Uri(uri).AbsolutePath.ToLower();
            _isLoginPage = path == "/login" || path.EndsWith("/login");
            _isWhatsNewPage = path == "/vad-ar-nytt" || path.EndsWith("/vad-ar-nytt");
        }
        catch
        {
            _isLoginPage = false;
            _isWhatsNewPage = false;
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateLoginStatus();
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}


