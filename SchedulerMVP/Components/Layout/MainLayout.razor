@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Authorization
@using SchedulerMVP.Data.Entities
@inject NavigationManager Navigation
@inject SchedulerMVP.Services.IModalService ModalService
@inject SchedulerMVP.Services.UserContextService UserContext
@implements IDisposable

@{
    var isLoginPage = _isLoginPage;
}

@if (isLoginPage)
{
    @* Login page - render ONLY Body, NO TopBar, NO app-root wrapper *@
    <div style="min-height: 100vh; background-color: #f7f7f7;">
        @Body
    </div>
}
else
{
    @* Normal page - require auth; otherwise redirect to login *@
    <AuthorizeView>
        <Authorized>
            <div class="app-root" style="display: flex; flex-direction: column; height: 100vh;">
                <TopBar />
                <div style="flex: 1; overflow: @((_isWhatsNewPage || _isGroupsManagePage || _isHelpPage) ? "auto" : "hidden"); display: flex; flex-direction: column;">
                    @Body
                </div>
                <Toast />
                <ConnectionHealthCheck />
                @if (_currentModal != null)
                {
                    <UserModal Modal="@_currentModal" OnClosed="OnModalClosed" />
                }
            </div>
        </Authorized>
        <NotAuthorized>
            @* Check if this is a shared schedule page (public, no auth required) *@
            @if (_isSharedSchedulePage)
            {
                @* Shared schedule page - public, no auth required, but show TopBar *@
                <div class="app-root" style="display: flex; flex-direction: column; height: 100vh;">
                    <TopBar />
                    <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        @Body
                    </div>
                </div>
            }
            else
            {
                <RedirectToLogin />
            }
        </NotAuthorized>
    </AuthorizeView>
}

@code {
    private bool _isLoginPage = false;
    private bool _isWhatsNewPage = false;
    private bool _isGroupsManagePage = false;
    private bool _isHelpPage = false;
    private bool _isSharedSchedulePage = false;
    private Modal? _currentModal = null;
    private List<Modal> _pendingModals = new();
    private bool _modalsLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        UpdateLoginStatus();
        Navigation.LocationChanged += OnLocationChanged;
        await LoadModalsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isLoginPage)
        {
            await LoadModalsAsync();
        }
    }

    private void UpdateLoginStatus()
    {
        try
        {
            var uri = Navigation.Uri.ToLower();
            var path = new Uri(uri).AbsolutePath.ToLower();
            _isLoginPage = path == "/login" || path.EndsWith("/login");
            _isWhatsNewPage = path == "/vad-ar-nytt" || path.EndsWith("/vad-ar-nytt");
            _isGroupsManagePage = path == "/grupper" || path.EndsWith("/grupper");
            _isHelpPage = path == "/hjalp" || path.EndsWith("/hjalp");
            _isSharedSchedulePage = path.StartsWith("/s/");
        }
        catch
        {
            _isLoginPage = false;
            _isWhatsNewPage = false;
            _isGroupsManagePage = false;
            _isHelpPage = false;
            _isSharedSchedulePage = false;
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateLoginStatus();
        StateHasChanged();
    }

    private async Task LoadModalsAsync()
    {
        // Don't load modals for login page or shared schedule pages (public, no auth)
        if (_isLoginPage || _isSharedSchedulePage || _modalsLoaded)
        {
            return;
        }

        try
        {
            var userId = await UserContext.GetCurrentUserIdAsync();
            
            if (string.IsNullOrEmpty(userId))
            {
                return;
            }

            // Get active modals for user (optimized query with indexes)
            var activeModals = await ModalService.GetActiveModalsForUserAsync(userId);
            
            _pendingModals = activeModals;
            _modalsLoaded = true;

            // Show first modal if any
            if (_pendingModals.Count > 0 && _currentModal == null)
            {
                _currentModal = _pendingModals[0];
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] Error loading modals: {ex.Message}");
        }
    }

    private async Task OnModalClosed()
    {
        if (_currentModal != null)
        {
            // Remove current modal from pending list
            _pendingModals.Remove(_currentModal);
            _currentModal = null;

            // Show next modal if any
            if (_pendingModals.Count > 0)
            {
                _currentModal = _pendingModals[0];
            }

            StateHasChanged();
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}


