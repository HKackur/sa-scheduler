@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using SchedulerMVP.Data.Entities
@inject SchedulerMVP.Services.UIState UI
@inject SchedulerMVP.Services.UserContextService UserContext
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject SchedulerMVP.Services.IPlaceService PlaceService
@inject IDbContextFactory<SchedulerMVP.Data.AppDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<SchedulerMVP.Data.ApplicationDbContext> AppDbFactory

@code {
    private bool isOpen;
    private int stepIndex; // 0 = intro, 1..3 = steps
    private int totalSteps = 3;
    private bool isDisposed;
    private List<SchedulerMVP.Data.Entities.Place> places = new();
    private int groupsCount = 0;

    protected override async Task OnInitializedAsync()
    {
        // CRITICAL: Onboarding must NEVER crash the app - if anything fails, just hide onboarding
        // CRITICAL: Onboarding is COMPLETELY SEPARATE from login - it only runs AFTER user is logged in
        isOpen = false; // Default to closed - only open if everything succeeds
        
        try
        {
            // First check if user is logged in - if not, don't show onboarding
            var userId = await UserContext.GetCurrentUserIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                return; // User not logged in - onboarding should never run
            }
            
            // Get onboarding status from database - if this fails, just don't show onboarding
            int? lastDone = null;
            try
            {
                await using var appDb = await AppDbFactory.CreateDbContextAsync();
                var user = await UserManager.FindByIdAsync(userId);
                if (user != null)
                {
                    // ONBOARDING DISABLED - OnboardingCompletedStep commented out
                    // lastDone = user.OnboardingCompletedStep;
                    lastDone = null; // Always show as not started when disabled
                }
            }
            catch 
            { 
                // If we can't read from DB (e.g., column doesn't exist), don't show onboarding
                // This is NOT an error - onboarding is optional and should never block login
                return;
            }
            
            // Check if user has already completed onboarding (step 3 or 4 = fully completed)
            if (lastDone.HasValue && lastDone >= 3)
            {
                // User has completed all steps - don't show onboarding
                isOpen = false;
                return;
            }
            
            // CRITICAL: Check if places exist - if they do, don't show step 1
            try
            {
                places = await PlaceService.GetPlacesAsync();
            }
            catch 
            { 
                places = new List<SchedulerMVP.Data.Entities.Place>(); 
            }
            
            // CRITICAL: Check if groups exist - if they do, don't show step 2
            try
            {
                await using var db = await DbFactory.CreateDbContextAsync();
                var authUserId = await UserContext.GetCurrentUserIdAsync();
                var isAdmin = await UserContext.IsAdminAsync();
                var groupsQuery = db.Groups.AsQueryable();
                if (!isAdmin && !string.IsNullOrEmpty(authUserId))
                {
                    groupsQuery = groupsQuery.Where(g => g.UserId == authUserId);
                }
                groupsCount = await groupsQuery.CountAsync();
            }
            catch 
            { 
                groupsCount = 0; 
            }
            
            // If places exist, mark step 1 as completed (but don't fail if save fails)
            if (places.Count > 0 && (!lastDone.HasValue || lastDone < 1))
            {
                try
                {
                    await SaveOnboardingStepAsync(1);
                    lastDone = 1;
                }
                catch { /* Don't fail if save fails */ }
            }
            
            // If groups exist, mark step 2 as completed (but don't fail if save fails)
            if (groupsCount > 0 && (!lastDone.HasValue || lastDone < 2))
            {
                try
                {
                    await SaveOnboardingStepAsync(2);
                    lastDone = 2;
                }
                catch { /* Don't fail if save fails */ }
            }
            
            // Determine which step to show
            if (!lastDone.HasValue)
            {
                // First time – show intro (step 0)
                isOpen = true;
                stepIndex = 0;
            }
            else if (lastDone == 0)
            {
                // Intro completed - show step 1 (or skip if places exist)
                if (places.Count > 0)
                {
                    if (groupsCount > 0)
                    {
                        // Has both - show step 3
                        isOpen = true;
                        stepIndex = 3;
                    }
                    else
                    {
                        // Has places but no groups - show step 2
                        isOpen = true;
                        stepIndex = 2;
                    }
                }
                else
                {
                    // No places - show step 1
                    isOpen = true;
                    stepIndex = 1;
                }
            }
            else if (lastDone == 1)
            {
                // Step 1 completed - show step 2 (or skip if groups exist)
                if (groupsCount > 0)
                {
                    // Has groups - show step 3
                    isOpen = true;
                    stepIndex = 3;
                }
                else
                {
                    // No groups - show step 2
                    isOpen = true;
                    stepIndex = 2;
                }
            }
            else if (lastDone == 2)
            {
                // Step 2 completed - show step 3
                isOpen = true;
                stepIndex = 3;
            }
            else if (lastDone == 3 || lastDone == 4)
            {
                // Step 3 or 4 completed - onboarding done
                isOpen = false;
            }
            
            // Subscribe to events (but don't fail if this fails)
            try
            {
                Nav.LocationChanged += OnLocationChanged;
                UI.OnChanged += CheckPlacesAndUpdateStep;
            }
            catch { /* Don't fail if subscription fails */ }
        }
        catch 
        { 
            // CRITICAL: If ANYTHING fails, just hide onboarding - never crash the app
            isOpen = false;
        }
    }
    
    private async Task SaveOnboardingStepAsync(int step)
    {
        // CRITICAL: Never throw exceptions - if save fails, just continue
        // CRITICAL: Onboarding save is OPTIONAL and should NEVER affect login or app functionality
        try
        {
            var userId = await UserContext.GetCurrentUserIdAsync();
            if (string.IsNullOrEmpty(userId)) return;
            
            await using var appDb = await AppDbFactory.CreateDbContextAsync();
            var user = await UserManager.FindByIdAsync(userId);
            if (user != null)
            {
                // ONBOARDING DISABLED - OnboardingCompletedStep commented out
                // user.OnboardingCompletedStep = step;
                // await UserManager.UpdateAsync(user);
                // Do nothing - onboarding is disabled
            }
        }
        catch 
        { 
            // Silently fail - onboarding save is not critical and should NEVER affect login
            // If column doesn't exist or update fails, just continue - onboarding is optional
        }
    }
    
    private async void CheckPlacesAndUpdateStep()
    {
        try
        {
            // Reload places when UI changes (e.g., after place creation)
            var newPlaces = await PlaceService.GetPlacesAsync();
            if (newPlaces.Count > 0 && places.Count == 0)
            {
                // Places were just created - if we're on step 1, skip to step 2
                places = newPlaces;
                if (stepIndex == 1 && isOpen)
                {
                    await CompleteCurrentAsync();
                }
            }
            else
            {
                places = newPlaces;
            }
            
            // Also check groups count
            try
            {
                await using var db = await DbFactory.CreateDbContextAsync();
                var userId = await UserContext.GetCurrentUserIdAsync();
                var isAdmin = await UserContext.IsAdminAsync();
                var groupsQuery = db.Groups.AsQueryable();
                if (!isAdmin && !string.IsNullOrEmpty(userId))
                {
                    groupsQuery = groupsQuery.Where(g => g.UserId == userId);
                }
                var newGroupsCount = await groupsQuery.CountAsync();
                if (newGroupsCount > 0 && groupsCount == 0)
                {
                    // Groups were just created - if we're on step 2, skip to step 3
                    groupsCount = newGroupsCount;
                    if (stepIndex == 2 && isOpen)
                    {
                        await CompleteCurrentAsync();
                    }
                }
                else
                {
                    groupsCount = newGroupsCount;
                }
            }
            catch { }
        }
        catch { }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (!isDisposed)
        {
            // CRITICAL: Hide modal when on /grupper page or if groups already exist
            var path = e.Location.TrimEnd('/').ToLowerInvariant();
            if (path == "/grupper")
            {
                isOpen = false;
            }
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task CompleteCurrentAsync()
    {
        try
        {
            // Persist as last completed step index (0..3) in database
            // stepIndex: 0 = intro, 1 = place, 2 = groups, 3 = planning
            // Save step as completed: 0 = intro done, 1 = place done, 2 = groups done, 3 = planning done, 4 = all done
            await SaveOnboardingStepAsync(stepIndex);
            var next = stepIndex + 1;
            if (next > totalSteps)
            {
                // Mark as fully completed (step 4)
                await SaveOnboardingStepAsync(4);
                isOpen = false;
            }
            else
            {
                stepIndex = next;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            // If something fails, just close onboarding
            isOpen = false;
            StateHasChanged();
        }
    }

    private async Task SkipAndNext()
    {
        try
        {
            // Log current step as completed when user clicks X
            await SaveOnboardingStepAsync(stepIndex);
            await CompleteCurrentAsync();
        }
        catch (Exception ex)
        {
            isOpen = false;
            StateHasChanged();
        }
    }

    private async Task StartAsync()
    {
        try
        {
            await CompleteCurrentAsync();
        }
        catch (Exception ex)
        {
            // Log but don't crash - just close onboarding
            isOpen = false;
            StateHasChanged();
        }
    }

    private async Task CreatePlaceAsync()
    {
        try
        {
            // Open place modal
            UI.ShouldOpenPlaceCreateModal = true;
            UI.RaiseChanged();
            
            // Don't complete step yet - wait for place to be created
            // The CheckPlacesAndUpdateStep will handle moving to next step when place is created
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // On error, still try to open modal
            UI.ShouldOpenPlaceCreateModal = true;
            UI.RaiseChanged();
            StateHasChanged();
        }
    }

    private async Task OpenGroupsManageAsync()
    {
        try
        {
            // CRITICAL: Close modal before navigating - don't show on /grupper page
            isOpen = false;
            StateHasChanged();
            
            // Mark step as complete
            await SaveOnboardingStepAsync(stepIndex);
            
            // Use forceLoad to bypass Blazor Server circuit if it's broken
            Nav.NavigateTo("/grupper", forceLoad: true);
        }
        catch (Exception ex)
        {
            // If Nav.NavigateTo fails, try JavaScript navigation as fallback
            try
            {
                await JS.InvokeVoidAsync("eval", "window.location.href = '/grupper';");
            }
            catch
            {
                // Last resort - close modal and user can navigate manually
                isOpen = false;
                StateHasChanged();
            }
        }
    }

    private async Task BeginPlanningAsync()
    {
        try
        {
            UI.IsCalendarViewMode = false;
            UI.RaiseChanged();
            await CompleteCurrentAsync();
        }
        catch (Exception ex)
        {
            isOpen = false;
            StateHasChanged();
        }
    }
}

@* CRITICAL: Onboarding is completely isolated - if anything fails, component renders nothing *@
@if (!isOpen)
{
    <text></text>
}
else
{
    @if (stepIndex == 0)
    {
        <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 7000;" @onclick="SkipAndNext"></div>
        <div class="bm-modal" style="z-index:7100;">
            <div class="bm-header">
                <h2 class="bm-title">Välkommen till testversionen av SportAdmins nya planeringsverktyg</h2>
            </div>
            <div class="bm-field">
                <div style="font-size:13px;color:#374151;line-height:1.5;">
                    <p style="margin:0 0 10px 0;">Du har nu fått tillgång till en testversion av en funktion som är under utveckling. Det betyder att inte alla funktioner är kompletta än, deisgn och layout är inte färdig och framför allt kommer det att regelbundet göras uppdateringar utan notiser. Detta kan i sin tur leda till att buggar kan uppstå.</p>
                    <p style="margin:0 0 10px 0;">Men med det sagt så är detta en testverison full av funktioner du fritt kan testa och känna på. Just nu finns inga kopplingar till SportAdmins övriga system, utan du får skapa platser och grupper manuellt. Innom kort planerar vi att kunna lägga till synk till er förening i SportAdmin.</p>
                    <p style="margin:0 0 10px 0;">Följ den korta guiden här efter för att enkelt komma igång. Sen är det fritt fram att börja skapa testplanering.</p>
                    <p style="margin:0;"><b>Då detta är är en testverion erbjuder vi ingen support på tjänsten. SportAdmins support kan tyvärr inte hjälpa dig med eventuella frågor eller problem du stöter på. Om du får problem eller vill rapportera en bugg ber vi dig kontakta personen du fick ditt inlogg från eller ansvarig för denna produkten henrik.kackur@sportadmin.se</b></p>
                </div>
            </div>
            <div class="bm-actions">
                <button type="button" class="btn-primary" @onclick="StartAsync">Kom igång</button>
            </div>
        </div>
    }
    else if (stepIndex == 1)
    {
        <!-- Position to the left of Platser & ytor sidebar, but closer -->
        <div class="onb-card" style="top: 100px; right: 350px;">
            <div class="onb-card-header">
                <div class="onb-card-title">Börja med att skapa en plats</div>
                <button class="onb-close" @onclick="SkipAndNext">✕</button>
            </div>
            <div class="onb-card-body">
                Inom kort kommer du kunna importera föreningens platser från SportAdmin, men du kan också skapa egna. Vi börjar med det.
            </div>
            <div class="onb-card-footer">
                <div class="onb-steps">Steg 1 av @totalSteps</div>
                <button class="tb-btn" style="height:30px; border:none; background:#1761a5; color:#fff; border-radius:6px; padding:6px 12px; cursor:pointer;" @onclick="CreatePlaceAsync">Skapa plats</button>
            </div>
        </div>
    }
    else if (stepIndex == 2 && !IsGroupsPage)
    {
        <!-- Position lower, still beside right sidebar (near Grupper) -->
        <div class="onb-card" style="top: 360px; right: 400px;">
            <div class="onb-card-header">
                <div class="onb-card-title">Lägg nu till några grupper</div>
                <button class="onb-close" @onclick="SkipAndNext">✕</button>
            </div>
            <div class="onb-card-body">
                Snart kan vi hämta alla era grupper direkt från SportAdmin. Börja med att testa skapa egna grupptyper och grupper. Grupptyper hjälper dig filtrera när du har många grupper.
            </div>
            <div class="onb-card-footer">
                <div class="onb-steps">Steg 2 av @totalSteps</div>
                <button class="tb-btn" style="height:30px; border:none; background:#1761a5; color:#fff; border-radius:6px; padding:6px 12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center;" @onclick="OpenGroupsManageAsync">Hantera grupper</button>
            </div>
        </div>
    }
    else if (stepIndex == 3 && !IsGroupsPage)
    {
        <div class="onb-card" style="top: 72px; left: 50%; transform: translateX(-50%);">
            <div class="onb-card-header">
                <div class="onb-card-title">Nu kan du börja bygga ditt första veckoschema</div>
                <button class="onb-close" @onclick="SkipAndNext">✕</button>
            </div>
            <div class="onb-card-body">
                Du kan skapa flera mallar och versioner. När du är nöjd kan du använda mallarna för att snabbt fylla kalendern med färdiga veckor (i kalendervyn).
            </div>
            <div class="onb-card-footer">
                <div class="onb-steps">Steg 3 av @totalSteps</div>
                <button class="tb-btn" style="height:30px;" @onclick="BeginPlanningAsync">Börja planera</button>
            </div>
        </div>
    }
}

<style>
    /* Keep onboarding pop-cards behind app modals but allow clicks through areas without cards */
    .onb-card{position:fixed; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 10px 24px rgba(16,24,40,.18); padding:10px; width:320px; z-index:1000}
    .onb-card-header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
    .onb-card-title{font-size:14px; font-weight:600; color:#111827}
    .onb-close{border:none; background:transparent; cursor:pointer; color:#6b7280; font-size:14px}
    .onb-card-body{font-size:12px; color:#374151; line-height:1.5; margin-bottom:8px}
    .onb-card-footer{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .onb-steps{font-size:11px; color:#6b7280}
    /* Modal styles to match BookingModal */
    .bm-modal{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:#fff;color:#0f1720;padding:28px;z-index:4000;border:1px solid #e6e7ea;border-radius:12px;min-width:560px;max-width:720px;width:90vw;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto}
    .bm-header{position:sticky;top:0;background:#fff;z-index:12;padding-bottom:12px;margin-bottom:12px}
    .bm-title{margin:0 0 12px 0;font-size:20px;font-weight:800;letter-spacing:-.02em}
    .bm-field{margin-bottom:12px}
    .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px;padding-bottom:4px}
    .btn-primary{padding:8px 16px;border:none;border-radius:10px;background:#1761a5;color:#fff;cursor:pointer;min-height:40px;display:inline-flex;align-items:center;justify-content:center;line-height:20px}
</style>

@code {
    private bool IsGroupsPage
    {
        get
        {
            try
            {
                var path = new Uri(Nav.Uri).AbsolutePath.TrimEnd('/').ToLowerInvariant();
                return path == "/grupper";
            }
            catch { return false; }
        }
    }

    public void Dispose()
    {
        isDisposed = true;
        try 
        { 
            Nav.LocationChanged -= OnLocationChanged;
            UI.OnChanged -= CheckPlacesAndUpdateStep;
        } 
        catch { }
    }
}
