@using Microsoft.EntityFrameworkCore
@using SchedulerMVP.Data
@inject IDbContextFactory<AppDbContext> DbFactory

@if (IsOpen && GroupType != null)
{
    <div class="modal-container" @onclick="OnBackdrop">
        <div class="bm-modal" @onclick:stopPropagation="true">
            <div class="bm-header">
                <h2 class="bm-title">Radera grupptyp</h2>
            </div>
            <div class="bm-modal-content">
                <p class="bm-text">Vill du radera grupptypen <strong>@GroupType.Name</strong>?</p>
            </div>
            <div class="bm-actions">
                <button type="button" @onclick="OnCancel" class="btn-outline">Avbryt</button>
                <button type="button" @onclick="OnDelete" class="btn-danger">Radera grupptypen</button>
            </div>
        </div>
    </div>
    <style>
        .modal-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:4000;display:flex;justify-content:center;align-items:flex-start;padding-top:50px;overflow-y:auto}
        .bm-modal{background:#fff;color:#0f1720;padding:28px;border:1px solid #e6e7ea;border-radius:12px;width:480px;box-shadow:0 8px 28px rgba(16,24,40,.18);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
        .bm-title{font-size:18px;font-weight:700;color:#0f1720;margin:0}
        .bm-text{margin:0;font-size:14px;line-height:1.5;color:#0f1720}
        .bm-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
    </style>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public SchedulerMVP.Data.Entities.GroupType? GroupType { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }

    private async Task OnDelete()
    {
        if (GroupType == null) return;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var groupType = await db.GroupTypes.FindAsync(GroupType.Id);
            if (groupType != null)
            {
                var name = groupType.Name;
                db.GroupTypes.Remove(groupType);
                // Optional: null out groups using this type
                var groups = await db.Groups.Where(g => g.GroupType == name).ToListAsync();
                foreach (var g in groups) g.GroupType = null;
                await db.SaveChangesAsync();
                await OnDeleted.InvokeAsync();
                await CloseAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[GroupTypeDeleteModal] Error deleting group type: {ex.Message}");
        }
    }

    private void OnBackdrop()
    {
        OnCancel();
    }

    private void OnCancel()
    {
        OnClose.InvokeAsync();
    }

    private async Task CloseAsync()
    {
        await OnClose.InvokeAsync();
    }
}
